{"id":"agon-04k","title":"Discord rooms: create thread + post via webhook with thread_id","description":"Implement Discord integration for Room creation: create (or reuse) webhook for parent channel (stored in discord_channels); create thread for room; store threadId on room; post messages into thread using webhook endpoint with ?thread_id=...nnDoD:n- New endpoint or interaction handler can create a room threadn- Posting into thread works (webhook thread_id)n- DB is updated with thread + webhook refsn- gate passes","notes":"Implemented Discord room creation: Discord.createOrFetchWebhook + Discord.createPublicThread (uses DISCORD_BOT_TOKEN via Config.redacted). Added POST /dev/room/create to upsert discord_channels, create thread, create room+room_agents, enqueue first turn. ArenaService now has createRoom with shared upsert logic; startArena uses it (legacy). npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:34.470323333+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T03:40:01.89890687+01:00","closed_at":"2026-02-04T03:40:01.89890687+01:00","close_reason":"Implemented Discord rooms as public threads + webhook reuse per parent channel. Added Discord.createOrFetchWebhook + createPublicThread, ArenaService.createRoom, and dev endpoint /dev/room/create that creates thread, upserts discord_channels webhook, persists room, and enqueues first turn. Gate passes. Reviewer APPROVE.","dependencies":[{"issue_id":"agon-04k","depends_on_id":"agon-3m6","type":"blocks","created_at":"2026-02-04T01:56:32.654243675+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-04k","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:26.88289332+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-18e","title":"Admin UI: room composer (create room + assign agents)","description":"Admin UI flow to create a room and assign agents/order.\n\nDoD:\n- Select parentChannelId + room name/topic + autoArchive\n- Select agents + turn order\n- Starts/enqueues first turn\n- Gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:13:13.836281699+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.325843363+01:00","closed_at":"2026-02-04T11:50:22.325843363+01:00","close_reason":"Implemented Solid room composer to create room and assign agents/order; gate passes."}
{"id":"agon-1e3","title":"Rooms (Discord threads) + multi-provider agents","description":"Goal: Introduce a Room abstraction mapped 1:1 to a Discord thread, allow a persona Agent to join many rooms, and support agents using different LLM providers (OpenAI/Anthropic/Gemini) in the same room.nnKey requirements:n- Room == Discord threadn- Webhook reused per parent channel (posts into thread via thread_id)n- Agent is reusable persona and can join many roomsn- Each agent can specify provider+model; turns can mix providersn- History source-of-truth is Discord thread; persist synced history in D1nnDefinition of Done (epic):n- New DB schema supports rooms, room_agents, discord_channels webhooks, provider/model per agentn- Worker can create/start a room thread and orchestrate turns via Queuen- LLM router can call correct provider per agent per turnn- Consumer fetches Discord thread history and syncs to D1n- docs/design.md updated to match","status":"closed","priority":1,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:54:56.023526961+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:51:57.763777675+01:00","closed_at":"2026-02-04T04:51:57.763777675+01:00","close_reason":"Epic complete: rooms=threads, webhook reuse, per-agent LLM routing, history sync, and hardening tasks (czz/rxp/1xp) are implemented; gate passes.","dependencies":[{"issue_id":"agon-1e3","depends_on_id":"agon-5oc","type":"relates-to","created_at":"2026-02-04T01:57:11.630197939+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-3m6","type":"relates-to","created_at":"2026-02-04T01:57:16.714894121+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-7fz","type":"relates-to","created_at":"2026-02-04T01:57:21.797550977+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-04k","type":"relates-to","created_at":"2026-02-04T01:57:26.880366005+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-81x","type":"relates-to","created_at":"2026-02-04T01:57:31.961521922+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-4rg","type":"relates-to","created_at":"2026-02-04T01:57:37.052271616+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-czz","type":"relates-to","created_at":"2026-02-04T03:12:42.887583815+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-1xp","type":"relates-to","created_at":"2026-02-04T03:12:46.907029959+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-rxp","type":"relates-to","created_at":"2026-02-04T03:12:50.16664512+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-1xp","title":"Chore: ensure tsgo is part of repo toolchain","description":"Address non-blocking review note: npm scripts use tsgo but it's not in devDependencies. Decide if we add tsgo as devDependency or document system requirement.nnDoD:n- Either tsgo added to devDependencies or documented in AGENTS/READMEn- gate passes","notes":"Documented tsgo requirement in AGENTS.md (npm run typecheck uses tsgo --noEmit). Gate passes.","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T03:12:39.052927786+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:12:14.111622279+01:00","closed_at":"2026-02-04T04:12:14.111622279+01:00","close_reason":"Documented tsgo requirement in AGENTS.md; gate passes.","dependencies":[{"issue_id":"agon-1xp","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T03:12:46.907715389+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-1y0","title":"Nix: add flake dev shell","description":"Add flake.nix (and flake.lock) providing a devShell for NixOS: nodejs, typescript-go (tsgo), cacert, and exports SSL_CERT_FILE so wrangler/workerd TLS works.\n\nDoD:\n- nix develop -c npm run dev:all works\n- gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:56:27.627383978+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T14:58:17.669718809+01:00","closed_at":"2026-02-04T14:58:17.669718809+01:00","close_reason":"Added flake.nix + flake.lock with devShell (nodejs_22, typescript-go/tsgo, cacert) and SSL_CERT_FILE export; verified nix develop exposes tsgo and CA bundle."}
{"id":"agon-25w","title":"Ops: apply D1 migrations to remote","description":"Apply latest Drizzle/SQL migrations to Cloudflare D1 remote database (agon-db) so production schema matches repo.nnDoD:n- npm run db:migrate -- --remote succeedsn- D1 schema includes latest columns","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T04:52:53.175211258+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:53:07.992650906+01:00","closed_at":"2026-02-04T04:53:07.992650906+01:00","close_reason":"Applied migrations to remote D1 (0001_outstanding_red_hulk.sql); command succeeded."}
{"id":"agon-3m6","title":"DB migration: arenas -\u003e rooms; add discord_channels + agent provider/model","description":"Implement Drizzle schema + migrations: rename arenas-\u003erooms, arena_agents-\u003eroom_agents, add discord_channels table for webhook storage per parent channel, update messages table to include discord_message_id + thread_id for sync/dedupe, add agents.llmProvider + agents.llmModel.nnDoD:n- drizzle schema updatedn- drizzle-kit generates migrationn- migrations apply locally + remoten- typecheck + gate pass","notes":"Resolved reviewer blockers by resetting migrations + D1 from scratch.\n\n- Deleted old migrations/meta and regenerated a clean initial migration for current schema (rooms/room_agents/discord_channels/messages, agents llm defaults).\n  - New migration: migrations/0000_clumsy_whistler.sql\n  - Snapshot keys now: agents, rooms, room_agents, discord_channels, messages\n- Reset D1 remote: deleted and recreated agon-db; updated wrangler.toml database_id to 1b0fdea6-be60-4408-9e58-ca6f531ca126\n- Applied migrations locally + remote\n- Queue retry idempotency: processTurn uses deterministic discordMessageId local-turn:\u003croomId\u003e:\u003cturnNumber\u003e and skips LLM on retry\n- DiscordWebhookPoster catch preserves DiscordWebhookPostFailed errors\n\nnpm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:24.238008488+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T03:12:00.48338614+01:00","closed_at":"2026-02-04T03:12:00.48338614+01:00","close_reason":"Implemented new Room/Agent schema (rooms, room_agents, discord_channels, message sync fields, per-agent provider/model defaults). Reset migrations to a clean initial 0000 and reset D1 remote. Added idempotent turn persistence and improved webhook error preservation. Reviewer APPROVE.","dependencies":[{"issue_id":"agon-3m6","depends_on_id":"agon-5oc","type":"blocks","created_at":"2026-02-04T01:56:22.482418586+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-3m6","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:16.717402761+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-4rg","title":"Room settings: per-room auto-archive config (research + implement)","description":"Determine Discord thread auto-archive options supported by the API and model them as per-room config (store in DB). Apply the selected auto-archive duration when creating the thread.nnDoD:n- Document supported values (minutes) in design docn- Add room.autoArchiveDurationMinutes (or similar)n- Thread creation uses stored valuen- gate passes","notes":"Implemented as part of Discord room creation: rooms.autoArchiveDurationMinutes exists in schema with allowed values 60|1440|4320|10080; /dev/room/create validates and stores it; Discord.createPublicThread uses it. docs/design.md documents supported values. gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:44.646477161+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:08:15.891958659+01:00","closed_at":"2026-02-04T04:08:15.891958659+01:00","close_reason":"Already implemented and documented (rooms.autoArchiveDurationMinutes + thread creation uses it).","dependencies":[{"issue_id":"agon-4rg","depends_on_id":"agon-04k","type":"blocks","created_at":"2026-02-04T01:56:42.817013427+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-4rg","depends_on_id":"agon-3m6","type":"blocks","created_at":"2026-02-04T01:56:56.87787907+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-4rg","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:37.054935423+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-598","title":"OpenRouter: update admin API/UI + db enum","description":"Expose openrouter in agents CRUD.\n\nDoD:\n- D1 schema allows llm_provider=openrouter (migration if needed)\n- Admin API schemas accept openrouter\n- Admin UI provider dropdown includes OpenRouter\n- gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:10:45.804768011+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T14:17:39.404030197+01:00","closed_at":"2026-02-04T14:17:39.404030197+01:00","close_reason":"Admin API schemas + admin UI agent dropdown now allow llmProvider=openrouter; D1 schema typing widened; gate passes."}
{"id":"agon-5d6","title":"Observability: internal turn event timeline","description":"Add minimal internal telemetry (not Cloudflare log replication): persist turn lifecycle events to D1 for debugging.\n\nIdea:\n- New table: room_turn_events (roomId, turnNumber, phase, status, createdAtMs, dataJson)\n- Write events in ArenaService around: start, discord sync, llm start/ok/fail, webhook post ok/fail, finish.\n- Admin endpoints + UI to view timeline.\n\nDoD:\n- Gate passes\n- UI can show timeline per room","status":"in_progress","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:12:55.19542054+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:18:19.427683951+01:00"}
{"id":"agon-5oc","title":"Design update: rooms/threads + per-agent provider routing","description":"Update docs/design.md to reflect final domain model: Rooms (threads), Agents (personas), room_agents membership, discord_channels webhook reuse, and turn loop using Discord thread history as source of truth.nnDoR:n- Epic agon-1e3 existsnnDoD:n- docs/design.md has: updated ERD, flow diagrams (text), webhook+thread_id strategy, idempotency story, and provider-per-agent routing descriptionn- Includes decisions + open questions for auto-archive duration values","notes":"Decisions: 1) Room == public thread under text channel (default). 2) History sync: include humans + our webhook messages; ignore other bots.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:19.151481722+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T02:07:55.870806264+01:00","closed_at":"2026-02-04T02:07:55.870806264+01:00","close_reason":"Updated docs/design.md: Room==public thread, webhook reuse per parent channel with thread_id posting, per-agent provider/model routing, Discord history as source of truth synced to D1, idempotent queue turns, and per-room auto-archive supported values.","dependencies":[{"issue_id":"agon-5oc","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:11.632678325+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-5tn","title":"OpenRouter: docs + local dev vars","description":"Document OpenRouter env vars and local setup.\n\nDoD:\n- AGENTS.md mentions OPENROUTER_API_KEY option\n- .dev.vars.example (or docs) added if desired\n- gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:10:45.834447054+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T14:17:44.402672722+01:00","closed_at":"2026-02-04T14:17:44.402672722+01:00","close_reason":"Documented OpenRouter env vars in AGENTS.md (OPENROUTER_API_KEY, optional HTTP-Referer/X-Title)."}
{"id":"agon-6i2","title":"LLM: add OpenRouter provider","description":"Add OpenRouter as a selectable per-agent LLM provider (OpenAI-compatible endpoint) with config via OPENROUTER_API_KEY.\n\nScope:\n- Router supports provider=openrouter\n- Admin API + UI allow selecting openrouter\n- Docs for env vars\n- Smoke test via dev room turn","status":"closed","priority":1,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:10:34.966582728+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T14:18:29.868674159+01:00","closed_at":"2026-02-04T14:18:29.868674159+01:00","close_reason":"Delivered OpenRouter provider support (router + admin API/UI + docs)."}
{"id":"agon-6kl","title":"DX: one-command dev (worker + admin UI)","description":"Provide a single root command to run backend (wrangler dev) and frontend (Solid admin Vite dev server) together.\n\nDoD:\n- `npm run dev:all` starts both processes\n- Admin Vite server proxies /admin to Wrangler dev port\n- Docs note command\n- gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T12:32:44.253844489+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T13:00:58.952262816+01:00","closed_at":"2026-02-04T13:00:58.952262816+01:00","close_reason":"Added npm run dev:all using concurrently; admin Vite proxies /admin to wrangler dev; documented in AGENTS.md; gate passes."}
{"id":"agon-7fz","title":"LLM router: call provider/model per agent per turn","description":"Replace global LLM_PROVIDER selection with per-call routing. Add LlmRouter service that takes (provider, model, prompt) and uses @effect/ai Model.make + provider layers (openai/anthropic/google) to call LanguageModel.generateText.nnDoD:n- Can generate text for OpenAI + Anthropic + Gemini based on input provider/modeln- Arena/Room turn processing uses agent.llmProvider+llmModeln- Retries/timeouts preservedn- gate passes","notes":"Implemented per-turn per-agent LLM routing via new LlmRouter service (provider+model+prompt). Updated ArenaService.processTurn to call LlmRouter using agent.llmProvider/llmModel. Rewired runtime in src/index.ts to provide LlmRouterLive instead of LlmLive; Env now includes ANTHROPIC_API_KEY + GOOGLE_AI_API_KEY. Gate passes (npm run gate).","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:29.324070465+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T03:24:19.47922129+01:00","closed_at":"2026-02-04T03:24:19.47922129+01:00","close_reason":"Implemented per-agent per-turn LLM routing via new LlmRouter service (openai/anthropic/gemini) using @effect/ai Model.make + provider layers. ArenaService now calls router using agent.llmProvider+agent.llmModel. Gate passes. Reviewer APPROVE.","dependencies":[{"issue_id":"agon-7fz","depends_on_id":"agon-3m6","type":"blocks","created_at":"2026-02-04T01:56:27.568016455+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-7fz","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:21.800787166+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-81x","title":"History sync: fetch thread messages each turn and persist to D1","description":"On each turn, fetch last N messages from Discord thread, transform into prompt, and upsert into D1 messages table (dedupe by discord_message_id). Ensure bots filtering rules are applied and human interruptions are captured.nnDoD:n- Consumer uses Discord thread history as contextn- D1 persists synced history with dedupen- Prompt built from synced messages + agent system promptn- gate passes","notes":"Implemented per-turn Discord thread history sync into D1. ArenaService.processTurn fetches recent thread messages; skips sync only when DISCORD_BOT_TOKEN is missing (otherwise fails turn for queue retry). Messages are classified (webhook_id =\u003e agent, author.bot =\u003e bot_other, else human) and upserted by discordMessageId with onConflictDoUpdate (edits supported). Prompt history is built from timestamp-sorted D1 messages with bot_other filtered and local-turn duplicates removed via time-window + agentId heuristic. History trimming is timestamp-based. npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:39.564885055+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:06:35.26811035+01:00","closed_at":"2026-02-04T04:06:29.273325921+01:00","close_reason":"Implemented per-turn Discord thread history sync into D1 and prompt builder; gate passes.","dependencies":[{"issue_id":"agon-81x","depends_on_id":"agon-04k","type":"blocks","created_at":"2026-02-04T01:56:37.736475044+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-81x","depends_on_id":"agon-3m6","type":"blocks","created_at":"2026-02-04T01:56:51.793360992+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-81x","depends_on_id":"agon-7fz","type":"blocks","created_at":"2026-02-04T01:57:01.958303961+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-81x","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:31.964256914+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-8to","title":"Admin: queue metrics link + optional Cloudflare Analytics API","description":"Show queue health without duplicating CF:\n- Always: provide deep link(s) and a short explanation where to see queue depth/rate in Cloudflare dashboard.\n- Optional: if CF API token is provided, call Cloudflare GraphQL Analytics API to show queue depth/throughput/errors in UI.\n\nDoD:\n- Minimal UI widget + docs\n- Gate passes","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:13:13.870351237+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.359123118+01:00","closed_at":"2026-02-04T11:50:22.359123118+01:00","close_reason":"Implemented Metrics page with Cloudflare deep links + explainer (config via localStorage); no CF dashboard duplication."}
{"id":"agon-ar2","title":"Admin API: auth + agents CRUD endpoints","description":"Add protected admin API endpoints in the worker to manage agents.\n\nDeliver:\n- Auth strategy: either Cloudflare Access (preferred) or ADMIN_TOKEN bearer.\n- Endpoints: GET/POST/PUT/DELETE /admin/agents\n- Validate payloads with Schema.\n- Persist to D1 agents table.\n\nDoD:\n- Endpoints covered by auth\n- Gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:12:55.041578077+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.143942546+01:00","closed_at":"2026-02-04T11:50:22.143942546+01:00","close_reason":"Implemented ADMIN_TOKEN auth + /admin/agents CRUD endpoints; gate passes."}
{"id":"agon-b5m","title":"Observability: structured Effect logging + Cloudflare correlation","description":"Add a baseline observability setup:\n- Structured JSON logging via Effect Logger (configurable LOG_LEVEL + LOG_FORMAT)\n- Correlation/annotations for HTTP requests (cf-ray, method, path) and queue turns (message.id, attempts, roomId, turnNumber)\n- Log spans for key operations (queue job, processTurn, discord sync, llm generate, webhook post)\n\nDoD:\n- Logs appear in Cloudflare (console) as structured JSON with annotations\n- Gate passes","notes":"Added baseline observability tied to Cloudflare logs:\n- New src/services/Observability.ts provides Effect Logger layer configured by LOG_LEVEL + LOG_FORMAT (json/logfmt/pretty), defaulting to json.\n- Runtime now includes Observability.layer.\n- HTTP handlers annotate logs with requestId (CF-Ray fallback UUID) + route and add log spans.\n- Queue consumer annotates logs with queue/message metadata (message.id, attempts, roomId, turnNumber) and adds spans; explicit Effect logs added in ArenaService.processTurn for major steps (discord sync, prompt build, llm generate, webhook post) without logging prompt/reply contents.\n- npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T04:57:36.566893793+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T05:06:38.707343986+01:00","closed_at":"2026-02-04T05:06:38.707343986+01:00","close_reason":"Implemented Effect-based structured logging + Cloudflare correlation; gate passes. Reviewer APPROVE."}
{"id":"agon-czz","title":"Hardening: make webhook posting idempotent on queue retries","description":"Address non-blocking review note: if queue retry happens after successful webhook post but before room state update, we can duplicate Discord messages. Add idempotency around Discord posting (e.g., persist a posted flag or store discord_message_id returned by webhook, or use Discord message dedupe when syncing history).nnDoD:n- Duplicate Discord posts prevented (or detected+ignored) across retriesn- Tested via simulated failure pathn- gate passes","notes":"Implemented webhook-post idempotency for queue retries: ArenaService.processTurn now skips Discord webhook posting on confirmed retries (existing local-turn message) when an equivalent non-local agent message already exists in recent D1 history (or Discord fetch) within the retry window. Gate passes.","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T03:12:39.021637676+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:51:10.863260473+01:00","closed_at":"2026-02-04T04:51:10.863260473+01:00","close_reason":"Added retry-safe Discord webhook posting (skip post when duplicate detected on confirmed retry); gate passes.","dependencies":[{"issue_id":"agon-czz","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T03:12:42.88812521+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-dao","title":"Admin API: rooms dashboard endpoints","description":"Expose read-only endpoints for rooms and room details.\n\nEndpoints:\n- GET /admin/rooms (status, topic, threadId, parentChannelId, currentTurn*, lastEnqueuedTurnNumber)\n- GET /admin/rooms/:id (include participants + recent messages)\n- POST /admin/rooms/:id/pause and /resume (optional)\n\nDoD:\n- Protected by admin auth\n- Gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:12:55.118753978+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.178448872+01:00","closed_at":"2026-02-04T11:50:22.178448872+01:00","close_reason":"Implemented /admin/rooms list + room detail endpoints; gate passes."}
{"id":"agon-dm4","title":"Admin UI: agents + rooms dashboard + observability links","description":"Build a simple internal admin UI (packages/admin) to manage Agents and monitor Rooms/Turns. Avoid duplicating Cloudflare dashboards; instead expose Agon-specific state from D1 and provide deep links / pointers to Cloudflare logs + queue metrics.\n\nScope:\n- Agents CRUD (provider/model/systemPrompt/avatar)\n- Rooms monitor (status, current turn, participants, threadId/parentChannelId)\n- Turn/event timeline for debugging (minimal internal telemetry)\n- External links to Cloudflare dashboards (logs, queue metrics)\n\nNon-goals:\n- Full log ingestion/replication of Cloudflare logs\n- Message-level queue inspection (not supported by CF Queues)\n\nDoD:\n- Admin UI can be protected (Access or ADMIN_TOKEN)\n- Gate passes","notes":"Planned tasks: agon-ar2 (admin auth+agents CRUD API), agon-tgg (agents UI), agon-dao (rooms dashboard API), agon-ysi (rooms monitor UI), agon-f02 (room creation + membership API), agon-18e (room composer UI), agon-5d6 (internal turn event timeline), agon-8to (queue metrics links/optional CF analytics).","status":"open","priority":1,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:12:44.865742092+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:13:18.358925902+01:00"}
{"id":"agon-eys","title":"DX: preconfigure Cloudflare dashboard link vars in wrangler.toml","description":"Metrics page pulls CF dashboard links from /admin/meta. Make it zero-config by setting CF_* vars in wrangler.toml [vars] (and optionally account_id).\n\nDoD:\n- wrangler.toml includes CF_ACCOUNT_ID/CF_WORKER_SERVICE/CF_QUEUE_NAME/CF_D1_NAME defaults\n- AGENTS.md no longer tells user to set CF_* manually\n- gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T13:51:32.111938865+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T13:53:39.580868827+01:00","closed_at":"2026-02-04T13:53:39.580868827+01:00","close_reason":"Set CF_* vars and account_id in wrangler.toml; removed manual CF_* step from AGENTS; gate passes."}
{"id":"agon-f02","title":"Admin API: room creation + membership management","description":"Expose admin endpoints to create/restart rooms and manage room_agents.\n\nEndpoints (suggested):\n- POST /admin/rooms (parentChannelId, threadId? or create thread? topic, autoArchiveDurationMinutes, agentIds+turnOrder)\n- PUT /admin/rooms/:id/participants\n\nDoD:\n- Protected by admin auth\n- Uses existing ArenaService.createRoom/upsert logic\n- Gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:13:13.805699707+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.22584146+01:00","closed_at":"2026-02-04T11:50:22.22584146+01:00","close_reason":"Implemented /admin/rooms create (thread+webhook as needed) and pause/resume; enqueues first job; gate passes."}
{"id":"agon-ise","title":"OpenRouter: implement provider routing","description":"Implement OpenRouter provider in LlmRouter (OpenAI-compatible baseUrl). Add OPENROUTER_API_KEY config and header support.\n\nDoD:\n- LlmProviderSchema includes openrouter\n- LlmRouter uses OpenAiClient with baseUrl https://openrouter.ai/api/v1\n- Config reads OPENROUTER_API_KEY\n- gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:10:45.775817049+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T14:17:33.358718691+01:00","closed_at":"2026-02-04T14:17:33.358718691+01:00","close_reason":"Implemented OpenRouter provider in LlmRouter using OpenAiClient apiUrl https://openrouter.ai/api/v1 + optional headers; reads OPENROUTER_API_KEY; gate passes."}
{"id":"agon-iwm","title":"Admin UI: remove diary-style copy from Metrics page","description":"Metrics page has a fluffy paragraph explaining what it is not. Replace with direct, actionable copy (what this page does) and keep it concise.\n\nDoD:\n- Remove 'intentionally does not replicate...' phrasing\n- Replace with 1-2 sentences describing what the page provides\n- gate passes","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T13:42:47.730833642+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T13:45:13.962730235+01:00","closed_at":"2026-02-04T13:45:13.962730235+01:00","close_reason":"Superseded by task to remove manual Cloudflare accountId config from Metrics page and fetch links from worker env."}
{"id":"agon-m6k","title":"Admin UI: Metrics links from worker env (no accountId form)","description":"Make Metrics page production-grade: no manual accountId/service/db/queue entry in UI.\n\nApproach:\n- Add /admin/meta endpoint returning Cloudflare dashboard deep links computed from worker env vars.\n- Admin UI fetches /admin/meta and renders links.\n- If not configured, show a short error with exact env var names to set.\n\nConfig env vars (optional):\n- CF_ACCOUNT_ID (required for links)\n- CF_WORKER_SERVICE (default: agon)\n- CF_QUEUE_NAME (default: arena-turns)\n- CF_D1_NAME (default: agon-db)\n\nDoD:\n- Metrics page has no inputs/localStorage\n- Links work when env vars set\n- gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T13:45:18.568255151+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T13:49:33.710531894+01:00","closed_at":"2026-02-04T13:49:33.710531894+01:00","close_reason":"Removed Metrics UI inputs/localStorage; added /admin/meta that returns Cloudflare deep links from worker env vars; updated AGENTS.md; gate passes."}
{"id":"agon-mn3","title":"Chore: configure git remote and push","description":"Set git remote origin, push current branch, and confirm repo is up to date with origin. Blocked until remote URL is provided.nnDoD:n- origin remote configuredn- git push succeedsn- git status shows up to date","notes":"Remote URL received: git@github.com:extropy-club/agon.git. Will set origin and push current branch (master).","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T04:52:21.579632952+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:08:29.12147485+01:00","closed_at":"2026-02-04T11:08:29.12147485+01:00","close_reason":"Configured origin (git@github.com:extropy-club/agon.git) and pushed master to GitHub."}
{"id":"agon-ofg","title":"Fix: ConfigProvider reads non-enumerable env vars (secrets)","description":"Wrangler/Workers env secrets may be non-enumerable so makeConfigLayer(Object.entries) misses them. This breaks Config.redacted lookups (ADMIN_TOKEN, DISCORD_BOT_TOKEN, API keys).\n\nDoD:\n- makeConfigLayer extracts string values using Object.getOwnPropertyNames / Reflect.ownKeys\n- Admin endpoints accept ADMIN_TOKEN from .dev.vars / secrets\n- Quick smoke test with curl shows /admin/agents returns 401 without auth and 200 with auth\n- gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T13:07:30.303259675+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T13:19:16.730342453+01:00","closed_at":"2026-02-04T13:19:16.730342453+01:00","close_reason":"Fixed ConfigProvider env mapping to include secrets/non-enumerable keys; admin endpoints now return 401/200 as expected; gate passes."}
{"id":"agon-rui","title":"Admin UI: take token from Vite .env (remove token form)","description":"Stop requiring manual token input in the admin UI. For local dev, read ADMIN token from Vite env (.env) and provide an example env file.\n\nDoD:\n- packages/admin reads token from import.meta.env.VITE_ADMIN_TOKEN in dev\n- Add packages/admin/.env.example with VITE_ADMIN_TOKEN and notes\n- UI no longer shows token input/Save; API uses env token (fallback optional)\n- Docs updated (AGENTS.md)\n- gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T13:23:27.397950965+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T13:32:14.645352727+01:00","closed_at":"2026-02-04T13:32:14.645352727+01:00","close_reason":"Admin UI token now comes from packages/admin/.env (VITE_ADMIN_TOKEN) with .env.example; removed token sidebar UI; added gitignore + docs warning; gate + admin checks pass."}
{"id":"agon-rxp","title":"Hardening: queue ack/send semantics","description":"Address non-blocking review note: current queue consumer acks message even if sending next job fails (ctx.waitUntil). Consider awaiting enqueue or making it part of the Effect pipeline with retries.nnDoD:n- Reliable enqueue semantics for next turnn- gate passes","notes":"Hardened queue ack/send semantics: queue consumer now awaits ARENA_QUEUE.send(next) before ack; on failure it calls message.retry with backoff. Added rooms.lastEnqueuedTurnNumber (migration 0001) and updates it after successful enqueue so redelivered messages don't re-enqueue duplicates; ArenaService retry path uses it. Gate passes.","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T03:12:39.085795971+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:51:10.892810284+01:00","closed_at":"2026-02-04T04:51:10.892810284+01:00","close_reason":"Queue now awaits enqueue before ack, retries explicitly on failure, and persists lastEnqueuedTurnNumber to avoid duplicate re-enqueues; gate passes.","dependencies":[{"issue_id":"agon-rxp","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T03:12:50.16743515+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-tgg","title":"Admin UI: Agents screen","description":"Implement SolidJS admin UI screen to list/create/edit/delete agents.\n\nDoD:\n- Can define agent name, systemPrompt, avatarUrl, llmProvider, llmModel\n- Calls admin API\n- Gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:12:55.08066634+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.259643938+01:00","closed_at":"2026-02-04T11:50:22.259643938+01:00","close_reason":"Implemented Solid admin Agents screen wired to /admin/agents; gate passes."}
{"id":"agon-ttj","title":"DX: fix wrangler dev TLS trust (CA bundle)","description":"Local workerd fails TLS handshake (Discord/OpenRouter) with 'TLS peer's certificate is not trusted' on some systems (notably Nix). Provide a repo-level fix so `npm run dev` works without manual env edits.\n\nApproach:\n- Add scripts/wrangler-dev.mjs wrapper to auto-detect a CA bundle and set SSL_CERT_FILE if missing.\n- Change package.json dev script to use wrapper.\n\nDoD:\n- Local calls to https://discord.com from worker succeed on affected setups\n- gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:49:50.786442658+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T14:56:04.787678058+01:00","closed_at":"2026-02-04T14:56:04.787678058+01:00","close_reason":"Added scripts/wrangler-dev.mjs wrapper that sets SSL_CERT_FILE to a CA bundle when missing/invalid (Nix-friendly) and updated npm run dev to use it; avoids passing secrets via argv; gate passes."}
{"id":"agon-ysi","title":"Admin UI: Rooms monitor + room detail","description":"Admin UI screen to monitor rooms and inspect a room.\n\nDoD:\n- Rooms list with key state\n- Room detail shows participants + last N messages + current turn pointer\n- Links to Discord thread\n- Gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:12:55.159103067+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.293365372+01:00","closed_at":"2026-02-04T11:50:22.293365372+01:00","close_reason":"Implemented Solid rooms monitor + room detail (participants + recent messages); gate passes."}
