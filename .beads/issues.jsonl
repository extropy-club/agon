{"id":"agon-04k","title":"Discord rooms: create thread + post via webhook with thread_id","description":"Implement Discord integration for Room creation: create (or reuse) webhook for parent channel (stored in discord_channels); create thread for room; store threadId on room; post messages into thread using webhook endpoint with ?thread_id=...nnDoD:n- New endpoint or interaction handler can create a room threadn- Posting into thread works (webhook thread_id)n- DB is updated with thread + webhook refsn- gate passes","notes":"Implemented Discord room creation: Discord.createOrFetchWebhook + Discord.createPublicThread (uses DISCORD_BOT_TOKEN via Config.redacted). Added POST /dev/room/create to upsert discord_channels, create thread, create room+room_agents, enqueue first turn. ArenaService now has createRoom with shared upsert logic; startArena uses it (legacy). npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:34.470323333+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T03:40:01.89890687+01:00","closed_at":"2026-02-04T03:40:01.89890687+01:00","close_reason":"Implemented Discord rooms as public threads + webhook reuse per parent channel. Added Discord.createOrFetchWebhook + createPublicThread, ArenaService.createRoom, and dev endpoint /dev/room/create that creates thread, upserts discord_channels webhook, persists room, and enqueues first turn. Gate passes. Reviewer APPROVE.","dependencies":[{"issue_id":"agon-04k","depends_on_id":"agon-3m6","type":"blocks","created_at":"2026-02-04T01:56:32.654243675+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-04k","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:26.88289332+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-1e3","title":"Rooms (Discord threads) + multi-provider agents","description":"Goal: Introduce a Room abstraction mapped 1:1 to a Discord thread, allow a persona Agent to join many rooms, and support agents using different LLM providers (OpenAI/Anthropic/Gemini) in the same room.nnKey requirements:n- Room == Discord threadn- Webhook reused per parent channel (posts into thread via thread_id)n- Agent is reusable persona and can join many roomsn- Each agent can specify provider+model; turns can mix providersn- History source-of-truth is Discord thread; persist synced history in D1nnDefinition of Done (epic):n- New DB schema supports rooms, room_agents, discord_channels webhooks, provider/model per agentn- Worker can create/start a room thread and orchestrate turns via Queuen- LLM router can call correct provider per agent per turnn- Consumer fetches Discord thread history and syncs to D1n- docs/design.md updated to match","status":"open","priority":1,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:54:56.023526961+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T01:54:56.023526961+01:00","dependencies":[{"issue_id":"agon-1e3","depends_on_id":"agon-5oc","type":"relates-to","created_at":"2026-02-04T01:57:11.630197939+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-3m6","type":"relates-to","created_at":"2026-02-04T01:57:16.714894121+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-7fz","type":"relates-to","created_at":"2026-02-04T01:57:21.797550977+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-04k","type":"relates-to","created_at":"2026-02-04T01:57:26.880366005+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-81x","type":"relates-to","created_at":"2026-02-04T01:57:31.961521922+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-4rg","type":"relates-to","created_at":"2026-02-04T01:57:37.052271616+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-czz","type":"relates-to","created_at":"2026-02-04T03:12:42.887583815+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-1xp","type":"relates-to","created_at":"2026-02-04T03:12:46.907029959+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-rxp","type":"relates-to","created_at":"2026-02-04T03:12:50.16664512+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-1xp","title":"Chore: ensure tsgo is part of repo toolchain","description":"Address non-blocking review note: npm scripts use tsgo but it's not in devDependencies. Decide if we add tsgo as devDependency or document system requirement.nnDoD:n- Either tsgo added to devDependencies or documented in AGENTS/READMEn- gate passes","status":"open","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T03:12:39.052927786+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T03:12:39.052927786+01:00","dependencies":[{"issue_id":"agon-1xp","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T03:12:46.907715389+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-3m6","title":"DB migration: arenas -\u003e rooms; add discord_channels + agent provider/model","description":"Implement Drizzle schema + migrations: rename arenas-\u003erooms, arena_agents-\u003eroom_agents, add discord_channels table for webhook storage per parent channel, update messages table to include discord_message_id + thread_id for sync/dedupe, add agents.llmProvider + agents.llmModel.nnDoD:n- drizzle schema updatedn- drizzle-kit generates migrationn- migrations apply locally + remoten- typecheck + gate pass","notes":"Resolved reviewer blockers by resetting migrations + D1 from scratch.\n\n- Deleted old migrations/meta and regenerated a clean initial migration for current schema (rooms/room_agents/discord_channels/messages, agents llm defaults).\n  - New migration: migrations/0000_clumsy_whistler.sql\n  - Snapshot keys now: agents, rooms, room_agents, discord_channels, messages\n- Reset D1 remote: deleted and recreated agon-db; updated wrangler.toml database_id to 1b0fdea6-be60-4408-9e58-ca6f531ca126\n- Applied migrations locally + remote\n- Queue retry idempotency: processTurn uses deterministic discordMessageId local-turn:\u003croomId\u003e:\u003cturnNumber\u003e and skips LLM on retry\n- DiscordWebhookPoster catch preserves DiscordWebhookPostFailed errors\n\nnpm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:24.238008488+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T03:12:00.48338614+01:00","closed_at":"2026-02-04T03:12:00.48338614+01:00","close_reason":"Implemented new Room/Agent schema (rooms, room_agents, discord_channels, message sync fields, per-agent provider/model defaults). Reset migrations to a clean initial 0000 and reset D1 remote. Added idempotent turn persistence and improved webhook error preservation. Reviewer APPROVE.","dependencies":[{"issue_id":"agon-3m6","depends_on_id":"agon-5oc","type":"blocks","created_at":"2026-02-04T01:56:22.482418586+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-3m6","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:16.717402761+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-4rg","title":"Room settings: per-room auto-archive config (research + implement)","description":"Determine Discord thread auto-archive options supported by the API and model them as per-room config (store in DB). Apply the selected auto-archive duration when creating the thread.nnDoD:n- Document supported values (minutes) in design docn- Add room.autoArchiveDurationMinutes (or similar)n- Thread creation uses stored valuen- gate passes","status":"open","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:44.646477161+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T01:55:44.646477161+01:00","dependencies":[{"issue_id":"agon-4rg","depends_on_id":"agon-04k","type":"blocks","created_at":"2026-02-04T01:56:42.817013427+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-4rg","depends_on_id":"agon-3m6","type":"blocks","created_at":"2026-02-04T01:56:56.87787907+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-4rg","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:37.054935423+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-5oc","title":"Design update: rooms/threads + per-agent provider routing","description":"Update docs/design.md to reflect final domain model: Rooms (threads), Agents (personas), room_agents membership, discord_channels webhook reuse, and turn loop using Discord thread history as source of truth.nnDoR:n- Epic agon-1e3 existsnnDoD:n- docs/design.md has: updated ERD, flow diagrams (text), webhook+thread_id strategy, idempotency story, and provider-per-agent routing descriptionn- Includes decisions + open questions for auto-archive duration values","notes":"Decisions: 1) Room == public thread under text channel (default). 2) History sync: include humans + our webhook messages; ignore other bots.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:19.151481722+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T02:07:55.870806264+01:00","closed_at":"2026-02-04T02:07:55.870806264+01:00","close_reason":"Updated docs/design.md: Room==public thread, webhook reuse per parent channel with thread_id posting, per-agent provider/model routing, Discord history as source of truth synced to D1, idempotent queue turns, and per-room auto-archive supported values.","dependencies":[{"issue_id":"agon-5oc","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:11.632678325+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-7fz","title":"LLM router: call provider/model per agent per turn","description":"Replace global LLM_PROVIDER selection with per-call routing. Add LlmRouter service that takes (provider, model, prompt) and uses @effect/ai Model.make + provider layers (openai/anthropic/google) to call LanguageModel.generateText.nnDoD:n- Can generate text for OpenAI + Anthropic + Gemini based on input provider/modeln- Arena/Room turn processing uses agent.llmProvider+llmModeln- Retries/timeouts preservedn- gate passes","notes":"Implemented per-turn per-agent LLM routing via new LlmRouter service (provider+model+prompt). Updated ArenaService.processTurn to call LlmRouter using agent.llmProvider/llmModel. Rewired runtime in src/index.ts to provide LlmRouterLive instead of LlmLive; Env now includes ANTHROPIC_API_KEY + GOOGLE_AI_API_KEY. Gate passes (npm run gate).","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:29.324070465+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T03:24:19.47922129+01:00","closed_at":"2026-02-04T03:24:19.47922129+01:00","close_reason":"Implemented per-agent per-turn LLM routing via new LlmRouter service (openai/anthropic/gemini) using @effect/ai Model.make + provider layers. ArenaService now calls router using agent.llmProvider+agent.llmModel. Gate passes. Reviewer APPROVE.","dependencies":[{"issue_id":"agon-7fz","depends_on_id":"agon-3m6","type":"blocks","created_at":"2026-02-04T01:56:27.568016455+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-7fz","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:21.800787166+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-81x","title":"History sync: fetch thread messages each turn and persist to D1","description":"On each turn, fetch last N messages from Discord thread, transform into prompt, and upsert into D1 messages table (dedupe by discord_message_id). Ensure bots filtering rules are applied and human interruptions are captured.nnDoD:n- Consumer uses Discord thread history as contextn- D1 persists synced history with dedupen- Prompt built from synced messages + agent system promptn- gate passes","notes":"Implemented per-turn Discord thread history sync into D1. ArenaService.processTurn fetches recent thread messages; skips sync only when DISCORD_BOT_TOKEN is missing (otherwise fails turn for queue retry). Messages are classified (webhook_id =\u003e agent, author.bot =\u003e bot_other, else human) and upserted by discordMessageId with onConflictDoUpdate (edits supported). Prompt history is built from timestamp-sorted D1 messages with bot_other filtered and local-turn duplicates removed via time-window + agentId heuristic. History trimming is timestamp-based. npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:39.564885055+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:06:35.26811035+01:00","closed_at":"2026-02-04T04:06:29.273325921+01:00","close_reason":"Implemented per-turn Discord thread history sync into D1 and prompt builder; gate passes.","dependencies":[{"issue_id":"agon-81x","depends_on_id":"agon-04k","type":"blocks","created_at":"2026-02-04T01:56:37.736475044+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-81x","depends_on_id":"agon-3m6","type":"blocks","created_at":"2026-02-04T01:56:51.793360992+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-81x","depends_on_id":"agon-7fz","type":"blocks","created_at":"2026-02-04T01:57:01.958303961+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-81x","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:31.964256914+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-czz","title":"Hardening: make webhook posting idempotent on queue retries","description":"Address non-blocking review note: if queue retry happens after successful webhook post but before room state update, we can duplicate Discord messages. Add idempotency around Discord posting (e.g., persist a posted flag or store discord_message_id returned by webhook, or use Discord message dedupe when syncing history).nnDoD:n- Duplicate Discord posts prevented (or detected+ignored) across retriesn- Tested via simulated failure pathn- gate passes","status":"open","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T03:12:39.021637676+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T03:12:39.021637676+01:00","dependencies":[{"issue_id":"agon-czz","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T03:12:42.88812521+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-rxp","title":"Hardening: queue ack/send semantics","description":"Address non-blocking review note: current queue consumer acks message even if sending next job fails (ctx.waitUntil). Consider awaiting enqueue or making it part of the Effect pipeline with retries.nnDoD:n- Reliable enqueue semantics for next turnn- gate passes","status":"open","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T03:12:39.085795971+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T03:12:39.085795971+01:00","dependencies":[{"issue_id":"agon-rxp","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T03:12:50.16743515+01:00","created_by":"Rafał Krzyważnia"}]}
