{"id":"agon-04k","title":"Discord rooms: create thread + post via webhook with thread_id","description":"Implement Discord integration for Room creation: create (or reuse) webhook for parent channel (stored in discord_channels); create thread for room; store threadId on room; post messages into thread using webhook endpoint with ?thread_id=...nnDoD:n- New endpoint or interaction handler can create a room threadn- Posting into thread works (webhook thread_id)n- DB is updated with thread + webhook refsn- gate passes","notes":"Implemented Discord room creation: Discord.createOrFetchWebhook + Discord.createPublicThread (uses DISCORD_BOT_TOKEN via Config.redacted). Added POST /dev/room/create to upsert discord_channels, create thread, create room+room_agents, enqueue first turn. ArenaService now has createRoom with shared upsert logic; startArena uses it (legacy). npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:34.470323333+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T03:40:01.89890687+01:00","closed_at":"2026-02-04T03:40:01.89890687+01:00","close_reason":"Implemented Discord rooms as public threads + webhook reuse per parent channel. Added Discord.createOrFetchWebhook + createPublicThread, ArenaService.createRoom, and dev endpoint /dev/room/create that creates thread, upserts discord_channels webhook, persists room, and enqueues first turn. Gate passes. Reviewer APPROVE.","dependencies":[{"issue_id":"agon-04k","depends_on_id":"agon-3m6","type":"blocks","created_at":"2026-02-04T01:56:32.654243675+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-04k","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:26.88289332+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-18e","title":"Admin UI: room composer (create room + assign agents)","description":"Admin UI flow to create a room and assign agents/order.\n\nDoD:\n- Select parentChannelId + room name/topic + autoArchive\n- Select agents + turn order\n- Starts/enqueues first turn\n- Gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:13:13.836281699+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.325843363+01:00","closed_at":"2026-02-04T11:50:22.325843363+01:00","close_reason":"Implemented Solid room composer to create room and assign agents/order; gate passes."}
{"id":"agon-1e3","title":"Rooms (Discord threads) + multi-provider agents","description":"Goal: Introduce a Room abstraction mapped 1:1 to a Discord thread, allow a persona Agent to join many rooms, and support agents using different LLM providers (OpenAI/Anthropic/Gemini) in the same room.nnKey requirements:n- Room == Discord threadn- Webhook reused per parent channel (posts into thread via thread_id)n- Agent is reusable persona and can join many roomsn- Each agent can specify provider+model; turns can mix providersn- History source-of-truth is Discord thread; persist synced history in D1nnDefinition of Done (epic):n- New DB schema supports rooms, room_agents, discord_channels webhooks, provider/model per agentn- Worker can create/start a room thread and orchestrate turns via Queuen- LLM router can call correct provider per agent per turnn- Consumer fetches Discord thread history and syncs to D1n- docs/design.md updated to match","status":"closed","priority":1,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:54:56.023526961+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:51:57.763777675+01:00","closed_at":"2026-02-04T04:51:57.763777675+01:00","close_reason":"Epic complete: rooms=threads, webhook reuse, per-agent LLM routing, history sync, and hardening tasks (czz/rxp/1xp) are implemented; gate passes.","dependencies":[{"issue_id":"agon-1e3","depends_on_id":"agon-5oc","type":"relates-to","created_at":"2026-02-04T01:57:11.630197939+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-3m6","type":"relates-to","created_at":"2026-02-04T01:57:16.714894121+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-7fz","type":"relates-to","created_at":"2026-02-04T01:57:21.797550977+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-04k","type":"relates-to","created_at":"2026-02-04T01:57:26.880366005+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-81x","type":"relates-to","created_at":"2026-02-04T01:57:31.961521922+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-4rg","type":"relates-to","created_at":"2026-02-04T01:57:37.052271616+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-czz","type":"relates-to","created_at":"2026-02-04T03:12:42.887583815+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-1xp","type":"relates-to","created_at":"2026-02-04T03:12:46.907029959+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-1e3","depends_on_id":"agon-rxp","type":"relates-to","created_at":"2026-02-04T03:12:50.16664512+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-1xp","title":"Chore: ensure tsgo is part of repo toolchain","description":"Address non-blocking review note: npm scripts use tsgo but it's not in devDependencies. Decide if we add tsgo as devDependency or document system requirement.nnDoD:n- Either tsgo added to devDependencies or documented in AGENTS/READMEn- gate passes","notes":"Documented tsgo requirement in AGENTS.md (npm run typecheck uses tsgo --noEmit). Gate passes.","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T03:12:39.052927786+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:12:14.111622279+01:00","closed_at":"2026-02-04T04:12:14.111622279+01:00","close_reason":"Documented tsgo requirement in AGENTS.md; gate passes.","dependencies":[{"issue_id":"agon-1xp","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T03:12:46.907715389+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-1y0","title":"Nix: add flake dev shell","description":"Add flake.nix (and flake.lock) providing a devShell for NixOS: nodejs, typescript-go (tsgo), cacert, and exports SSL_CERT_FILE so wrangler/workerd TLS works.\n\nDoD:\n- nix develop -c npm run dev:all works\n- gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:56:27.627383978+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T14:58:17.669718809+01:00","closed_at":"2026-02-04T14:58:17.669718809+01:00","close_reason":"Added flake.nix + flake.lock with devShell (nodejs_22, typescript-go/tsgo, cacert) and SSL_CERT_FILE export; verified nix develop exposes tsgo and CA bundle."}
{"id":"agon-25w","title":"Ops: apply D1 migrations to remote","description":"Apply latest Drizzle/SQL migrations to Cloudflare D1 remote database (agon-db) so production schema matches repo.nnDoD:n- npm run db:migrate -- --remote succeedsn- D1 schema includes latest columns","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T04:52:53.175211258+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:53:07.992650906+01:00","closed_at":"2026-02-04T04:53:07.992650906+01:00","close_reason":"Applied migrations to remote D1 (0001_outstanding_red_hulk.sql); command succeeded."}
{"id":"agon-3m6","title":"DB migration: arenas -\u003e rooms; add discord_channels + agent provider/model","description":"Implement Drizzle schema + migrations: rename arenas-\u003erooms, arena_agents-\u003eroom_agents, add discord_channels table for webhook storage per parent channel, update messages table to include discord_message_id + thread_id for sync/dedupe, add agents.llmProvider + agents.llmModel.nnDoD:n- drizzle schema updatedn- drizzle-kit generates migrationn- migrations apply locally + remoten- typecheck + gate pass","notes":"Resolved reviewer blockers by resetting migrations + D1 from scratch.\n\n- Deleted old migrations/meta and regenerated a clean initial migration for current schema (rooms/room_agents/discord_channels/messages, agents llm defaults).\n  - New migration: migrations/0000_clumsy_whistler.sql\n  - Snapshot keys now: agents, rooms, room_agents, discord_channels, messages\n- Reset D1 remote: deleted and recreated agon-db; updated wrangler.toml database_id to 1b0fdea6-be60-4408-9e58-ca6f531ca126\n- Applied migrations locally + remote\n- Queue retry idempotency: processTurn uses deterministic discordMessageId local-turn:\u003croomId\u003e:\u003cturnNumber\u003e and skips LLM on retry\n- DiscordWebhookPoster catch preserves DiscordWebhookPostFailed errors\n\nnpm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:24.238008488+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T03:12:00.48338614+01:00","closed_at":"2026-02-04T03:12:00.48338614+01:00","close_reason":"Implemented new Room/Agent schema (rooms, room_agents, discord_channels, message sync fields, per-agent provider/model defaults). Reset migrations to a clean initial 0000 and reset D1 remote. Added idempotent turn persistence and improved webhook error preservation. Reviewer APPROVE.","dependencies":[{"issue_id":"agon-3m6","depends_on_id":"agon-5oc","type":"blocks","created_at":"2026-02-04T01:56:22.482418586+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-3m6","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:16.717402761+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-4kb","title":"Discord slash command system for Agon management","description":"Design and implement a comprehensive Discord slash command interface for managing agents, rooms, and arena operations directly from Discord. Replaces or supplements the Admin UI for terminal-first users.","design":"## Command Structure\n\n### /agon agent\n- `create` - Create new agent with all schema fields\n  - Required: name (string), system_prompt (string)\n  - Optional: provider (choice: openai|anthropic|gemini|openrouter), model (string), temperature (number 0-2), max_tokens (int), thinking_level (choice), thinking_budget_tokens (int)\n- `list` - Show all agents (paginated embed)\n- `show` - Display agent details by ID\n- `delete` - Remove agent (with confirmation)\n\n### /agon room\n- `create` - Create new debate room\n  - Required: topic (string), agents (string - comma-separated IDs)\n  - Optional: title (string), parent_channel (channel), audience_slot_duration (int), room_token_limit (int)\n- `status` - Show current room state, turn, participants\n- `pause` / `resume` - Control room flow\n- `kick` - Remove agent from room (provide alternative)\n\n### /agon help\n- Show available commands and quick reference\n\n## Implementation Notes\n\n- Use ApplicationCommandOptionType.Subcommand for nesting\n- Command registration via Discord REST API (POST /applications/{id}/commands)\n- Store command definitions in code for version control\n- Parse interaction data using discord-api-types helpers\n- Permission: restrict to users with MANAGE_THREADS or admin role\n- Response types: ephemeral for sensitive ops, public for status\n\n## Open Questions\n\n1. Should agent create be restricted to admin users only?\n2. How to handle model validation per provider?\n3. Should room creation be thread-bound or allow any channel?","acceptance_criteria":"- All /agon commands register successfully with Discord\n- Agent CRUD works via slash commands with proper validation\n- Room management commands functional\n- Commands respect permission boundaries\n- Help command provides useful guidance\n- All commands respond within 3s (Discord requirement) or use deferred responses","notes":"## Consensus Design (Approved)\n\n### 1. Session State: `command_sessions` table in D1\n```sql\nCREATE TABLE command_sessions (\n  id TEXT PRIMARY KEY,\n  kind TEXT, -- 'agent_create' | 'agent_delete' | 'room_create' | 'agent_list_page'\n  discord_user_id TEXT NOT NULL,\n  channel_id TEXT,\n  message_id TEXT,\n  state_json TEXT,\n  created_at_ms INTEGER,\n  updated_at_ms INTEGER,\n  expires_at_ms INTEGER\n);\n```\n- Use D1 for transactional updates\n- Cleanup expired rows on every access\n\n### 2. Wizard Flow: Ephemeral-First (No DM Required)\n- Modal → Ephemeral message with components → Save\n- DM is polish/feature, not core requirement\n- Fallback to ephemeral if DM fails\n\n### 3. 3-Second Timeout: Defer + waitUntil + Edit\n- Always defer for heavy commands\n- Run work in ctx.waitUntil()\n- New service: DiscordInteractions.ts (follow-ups, edit-original)\n- Autocomplete (type 4) cannot defer - must be fast\n\n### 4. Agent Delete: Soft Delete (Archive)\n- Add `archived_at_ms` to agents table\n- Filter archived from autocomplete/list\n- Existing rooms continue working\n\n### 5. Implementation Order\n1. Foundation: Router (types 2/3/4/5), whitelist, DiscordInteractions, command_sessions\n2. Autocomplete (agon-9qy)\n3. Deferral wrapper\n4. Wizard (agon-4kb.2)\n5. Other commands\n\n### 6. Additional\n- Separate `npm run discord:sync` script (not on deploy)\n- Use `default_member_permissions` as defense-in-depth only\n- Whitelist is mandatory gate","status":"open","priority":2,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:16:42.556797715+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T12:47:57.908094351+01:00"}
{"id":"agon-4kb.1","title":"Command registration system with whitelist auth","description":"Build the foundation for Discord slash commands including whitelist-based permission system.","design":"1. Add DISCORD_ALLOWED_USER_IDS to Settings table (JSON array of Discord user IDs)\n2. Create src/discord/router.ts handling types 2/3/4/5:\n   - Type 2: Chat input commands → dispatch to command handlers\n   - Type 3: Message components (buttons/selects) → dispatch by custom_id\n   - Type 4: Autocomplete → query and return choices\n   - Type 5: Modal submit → dispatch by custom_id\n3. Whitelist guard: Check interaction.user.id or interaction.member.user.id against DISCORD_ALLOWED_USER_IDS before any handler\n4. Create src/services/DiscordInteractions.ts with:\n   - editOriginalResponse(appId, token, payload)\n   - createFollowupMessage(appId, token, payload)\n5. Command definitions as typed objects using discord-api-types\n6. Create npm run discord:sync script (separate from deploy) that PUTs commands to Discord\n7. Use default_member_permissions as defense-in-depth only","acceptance_criteria":"- Commands appear in Discord when typing /agon\n- Whitelist setting editable via Admin UI\n- Non-whitelisted users get ephemeral 'unauthorized' message\n- Command definitions version controlled in code","status":"open","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:27:23.456459894+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T12:48:18.906742252+01:00","dependencies":[{"issue_id":"agon-4kb.1","depends_on_id":"agon-4kb","type":"parent-child","created_at":"2026-02-05T12:27:23.457753143+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-4kb.2","title":"Guided agent creation with models.dev integration","description":"Implement multi-step modal flow for creating agents with live model discovery from models.dev.","design":"Flow (ephemeral, no DM):\n1. /agon agent create triggers MODAL (type 9) with:\n   - name: TextInput SHORT, required, max 100\n   - system_prompt: TextInput PARAGRAPH, required, max 4000\n2. On MODAL_SUBMIT (type 5):\n   - Create command_sessions row with kind='agent_create', state_json={name, system_prompt, step: 'provider'}\n   - Respond with ephemeral message containing:\n     - Provider select (StringSelect: openai/anthropic/gemini/openrouter)\n     - Model select (populated from models.dev for chosen provider)\n     - Set Advanced button (opens second modal)\n     - Save button\n3. On component interactions:\n   - Update command_sessions state_json\n   - If Save: validate, insert to agents table, delete session, confirm\n4. models.dev integration:\n   - Fetch https://models.dev/api.json, cache 1 hour\n   - Filter by selected provider\n   - Show modelId in select options\n5. State tracking via custom_id: agon:agent:create:{action}:{session_id}","acceptance_criteria":"- Full wizard completes and creates agent in DB\n- Model list populated from models.dev\n- Can skip optional steps and save with defaults\n- DM flow works even if user runs command from any channel\n- Proper validation at each step","status":"open","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:27:23.490378378+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T12:48:18.942719458+01:00","dependencies":[{"issue_id":"agon-4kb.2","depends_on_id":"agon-4kb","type":"parent-child","created_at":"2026-02-05T12:27:23.491773511+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-4kb.3","title":"Agent list, show, delete commands","description":"Implement remaining agent CRUD operations via slash commands.","design":"Use command_sessions for pagination state.\n\n/agon agent list:\n- Query: SELECT * FROM agents WHERE archived_at_ms IS NULL ORDER BY name LIMIT 10 OFFSET ?\n- Response: Ephemeral embed with 10 agents\n- Components: Prev/Next buttons with custom_id containing session_id\n- Store offset in command_sessions.state_json\n\n/agon agent show:\n- Arg: agent (autocomplete-enabled)\n- Query agent by ID\n- Response: Ephemeral embed with all fields\n- Component: Delete button (triggers confirmation)\n\n/agon agent delete:\n- Arg: agent (autocomplete-enabled)\n- Create command_sessions row with kind='agent_delete', state_json={agent_id}\n- Respond with ephemeral confirmation: Delete {agent_name}? + Confirm/Cancel buttons\n- On confirm: UPDATE agents SET archived_at_ms = ? WHERE id = ?\n- Cannot delete if agent is rooms.currentTurnAgentId (check first)","acceptance_criteria":"- list shows paginated results with working navigation\n- show displays all agent fields formatted nicely\n- delete has confirmation and removes agent\n- All responses ephemeral (private to user)","status":"open","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:27:23.525103792+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T12:48:46.869871599+01:00","dependencies":[{"issue_id":"agon-4kb.3","depends_on_id":"agon-4kb","type":"parent-child","created_at":"2026-02-05T12:27:23.526418389+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-4kb.4","title":"Room create command with multi-agent autocomplete","description":"Implement room creation via slash command with support for multiple agents.","design":"Always defer (type 5) then edit original.\n\nCommand: /agon room create\nArgs:\n- topic: STRING required, max 100\n- title: STRING optional, max 100\n- agent1: STRING autocomplete required\n- agent2..agent5: STRING autocomplete optional\n\nFlow:\n1. Validate channel type is GUILD_TEXT (not thread, not DM) - use Discord API if needed\n2. Respond with DEFERRED_CHANNEL_MESSAGE_WITH_SOURCE (type 5)\n3. In ctx.waitUntil():\n   - Validate all agent IDs exist and are not archived\n   - Ensure webhook mapping exists for parent channel (create if missing)\n   - Create room in D1\n   - Create Discord thread via API\n   - Store thread mapping in discord_channels\n   - Enqueue first turn to ARENA_QUEUE\n   - Edit original response with success message + thread link\n\nError handling:\n- Any failure → edit original with ephemeral error message\n- Thread creation failure → cleanup room, error message\n\nAutocomplete:\n- Same as agon-9qy but exclude already-selected agents from dropdown","acceptance_criteria":"- Room creates successfully with 1-5 agents\n- Thread created in current channel\n- Autocomplete works for all agent fields\n- Public confirmation with thread link\n- Proper error messages for edge cases","status":"open","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:27:23.558967537+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T12:48:19.007319221+01:00","dependencies":[{"issue_id":"agon-4kb.4","depends_on_id":"agon-4kb","type":"parent-child","created_at":"2026-02-05T12:27:23.560393005+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-4kb.5","title":"Room status, pause, resume commands","description":"Implement room lifecycle management commands.","design":"All commands must be run inside an Agon room thread (check rooms.threadId matches interaction.channel_id).\n\n/agon room status:\n- Query room by threadId\n- Response: Ephemeral embed with:\n  - Title, topic, status\n  - Current turn number and agent\n  - Agent list with turn order\n  - Next turn ETA if active\n\n/agon room pause:\n- Set room status to 'paused'\n- Lock Discord thread (best effort in background)\n- Ephemeral confirmation\n\n/agon room resume:\n- Set room status to 'active'\n- Compute nextTurnNumber = currentTurnNumber + 1\n- Enqueue to ARENA_QUEUE if not already enqueued\n- Update rooms.lastEnqueuedTurnNumber\n- Unlock Discord thread (best effort)\n- Ephemeral confirmation\n\nPermission: Whitelisted users only (already checked by router guard)","acceptance_criteria":"- status shows accurate room state\n- pause stops turn processing\n- resume resumes turn processing\n- Thread lock/unlock synchronized with pause state\n- All responses ephemeral","status":"open","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:27:23.593469606+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T12:48:19.040071682+01:00","dependencies":[{"issue_id":"agon-4kb.5","depends_on_id":"agon-4kb","type":"parent-child","created_at":"2026-02-05T12:27:23.594718605+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-4kb.6","title":"Help command","description":"Simple help command listing all available /agon commands.","design":"Command: /agon help\n\nResponse: Ephemeral embed with:\n- Brief Agon description\n- Categorized commands:\n  - Agent Management: create, list, show, delete\n  - Room Management: create, status, pause, resume\n  - Help: help\n- Quick example: /agon agent create\n- Footer: Link to docs (if exists)\n\nGenerate content from shared command registry to avoid drift.","acceptance_criteria":"- Shows all commands with descriptions\n- Formatted nicely in embed\n- Ephemeral response","status":"open","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:27:23.627958752+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T12:48:19.076122647+01:00","dependencies":[{"issue_id":"agon-4kb.6","depends_on_id":"agon-4kb","type":"parent-child","created_at":"2026-02-05T12:27:23.629170914+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-4rg","title":"Room settings: per-room auto-archive config (research + implement)","description":"Determine Discord thread auto-archive options supported by the API and model them as per-room config (store in DB). Apply the selected auto-archive duration when creating the thread.nnDoD:n- Document supported values (minutes) in design docn- Add room.autoArchiveDurationMinutes (or similar)n- Thread creation uses stored valuen- gate passes","notes":"Implemented as part of Discord room creation: rooms.autoArchiveDurationMinutes exists in schema with allowed values 60|1440|4320|10080; /dev/room/create validates and stores it; Discord.createPublicThread uses it. docs/design.md documents supported values. gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:44.646477161+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:08:15.891958659+01:00","closed_at":"2026-02-04T04:08:15.891958659+01:00","close_reason":"Already implemented and documented (rooms.autoArchiveDurationMinutes + thread creation uses it).","dependencies":[{"issue_id":"agon-4rg","depends_on_id":"agon-04k","type":"blocks","created_at":"2026-02-04T01:56:42.817013427+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-4rg","depends_on_id":"agon-3m6","type":"blocks","created_at":"2026-02-04T01:56:56.87787907+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-4rg","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:37.054935423+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-598","title":"OpenRouter: update admin API/UI + db enum","description":"Expose openrouter in agents CRUD.\n\nDoD:\n- D1 schema allows llm_provider=openrouter (migration if needed)\n- Admin API schemas accept openrouter\n- Admin UI provider dropdown includes OpenRouter\n- gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:10:45.804768011+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T14:17:39.404030197+01:00","closed_at":"2026-02-04T14:17:39.404030197+01:00","close_reason":"Admin API schemas + admin UI agent dropdown now allow llmProvider=openrouter; D1 schema typing widened; gate passes."}
{"id":"agon-5d6","title":"Observability: internal turn event timeline","description":"Add minimal internal telemetry (not Cloudflare log replication): persist turn lifecycle events to D1 for debugging.\n\nIdea:\n- New table: room_turn_events (roomId, turnNumber, phase, status, createdAtMs, dataJson)\n- Write events in ArenaService around: start, discord sync, llm start/ok/fail, webhook post ok/fail, finish.\n- Admin endpoints + UI to view timeline.\n\nDoD:\n- Gate passes\n- UI can show timeline per room","notes":"Implemented internal turn event timeline: added D1 table room_turn_events + migration 0002_confused_runaways; added TurnEventService (best-effort writes) and integrated into ArenaService (start/discord_sync/llm_*/webhook_post_*/finish + finish fail on errors). Added admin endpoint GET /admin/rooms/:roomId/events and Solid admin UI timeline in RoomDetail. Gate passes (npm run gate).","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:12:55.19542054+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T17:36:14.717145113+01:00","closed_at":"2026-02-04T17:36:14.717145113+01:00","close_reason":"Implemented: room_turn_events table, TurnEventService, admin endpoint, timeline UI. Gate passes."}
{"id":"agon-5oc","title":"Design update: rooms/threads + per-agent provider routing","description":"Update docs/design.md to reflect final domain model: Rooms (threads), Agents (personas), room_agents membership, discord_channels webhook reuse, and turn loop using Discord thread history as source of truth.nnDoR:n- Epic agon-1e3 existsnnDoD:n- docs/design.md has: updated ERD, flow diagrams (text), webhook+thread_id strategy, idempotency story, and provider-per-agent routing descriptionn- Includes decisions + open questions for auto-archive duration values","notes":"Decisions: 1) Room == public thread under text channel (default). 2) History sync: include humans + our webhook messages; ignore other bots.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:19.151481722+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T02:07:55.870806264+01:00","closed_at":"2026-02-04T02:07:55.870806264+01:00","close_reason":"Updated docs/design.md: Room==public thread, webhook reuse per parent channel with thread_id posting, per-agent provider/model routing, Discord history as source of truth synced to D1, idempotent queue turns, and per-room auto-archive supported values.","dependencies":[{"issue_id":"agon-5oc","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:11.632678325+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-5tn","title":"OpenRouter: docs + local dev vars","description":"Document OpenRouter env vars and local setup.\n\nDoD:\n- AGENTS.md mentions OPENROUTER_API_KEY option\n- .dev.vars.example (or docs) added if desired\n- gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:10:45.834447054+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T14:17:44.402672722+01:00","closed_at":"2026-02-04T14:17:44.402672722+01:00","close_reason":"Documented OpenRouter env vars in AGENTS.md (OPENROUTER_API_KEY, optional HTTP-Referer/X-Title)."}
{"id":"agon-6i2","title":"LLM: add OpenRouter provider","description":"Add OpenRouter as a selectable per-agent LLM provider (OpenAI-compatible endpoint) with config via OPENROUTER_API_KEY.\n\nScope:\n- Router supports provider=openrouter\n- Admin API + UI allow selecting openrouter\n- Docs for env vars\n- Smoke test via dev room turn","status":"closed","priority":1,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:10:34.966582728+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T14:18:29.868674159+01:00","closed_at":"2026-02-04T14:18:29.868674159+01:00","close_reason":"Delivered OpenRouter provider support (router + admin API/UI + docs)."}
{"id":"agon-6kl","title":"DX: one-command dev (worker + admin UI)","description":"Provide a single root command to run backend (wrangler dev) and frontend (Solid admin Vite dev server) together.\n\nDoD:\n- `npm run dev:all` starts both processes\n- Admin Vite server proxies /admin to Wrangler dev port\n- Docs note command\n- gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T12:32:44.253844489+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T13:00:58.952262816+01:00","closed_at":"2026-02-04T13:00:58.952262816+01:00","close_reason":"Added npm run dev:all using concurrently; admin Vite proxies /admin to wrangler dev; documented in AGENTS.md; gate passes."}
{"id":"agon-6mw","title":"Fix: Discord/OpenRouter auth fails due to quoted .dev.vars","description":"Current dev wrappers write .dev.vars with quoted values. On some Wrangler setups this can leak quotes into env values, causing Discord/OpenRouter 401 (Authorization header includes quotes).\n\nDoD:\n- scripts/wrangler-dev.mjs writes unquoted values (sanitized) and can rewrite existing quoted .dev.vars\n- Discord.ts and LlmRouter sanitize tokens by trimming surrounding quotes\n- End-to-end: Discord fetchRecentMessages no longer 401 when token is correct\n- gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T15:14:15.25159474+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T15:29:06.816434266+01:00","closed_at":"2026-02-04T15:29:06.816434266+01:00","close_reason":"Fixed dev wrapper + token sanitization to avoid Discord/OpenRouter 401 from quoted secrets; gate passes."}
{"id":"agon-7fz","title":"LLM router: call provider/model per agent per turn","description":"Replace global LLM_PROVIDER selection with per-call routing. Add LlmRouter service that takes (provider, model, prompt) and uses @effect/ai Model.make + provider layers (openai/anthropic/google) to call LanguageModel.generateText.nnDoD:n- Can generate text for OpenAI + Anthropic + Gemini based on input provider/modeln- Arena/Room turn processing uses agent.llmProvider+llmModeln- Retries/timeouts preservedn- gate passes","notes":"Implemented per-turn per-agent LLM routing via new LlmRouter service (provider+model+prompt). Updated ArenaService.processTurn to call LlmRouter using agent.llmProvider/llmModel. Rewired runtime in src/index.ts to provide LlmRouterLive instead of LlmLive; Env now includes ANTHROPIC_API_KEY + GOOGLE_AI_API_KEY. Gate passes (npm run gate).","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:29.324070465+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T03:24:19.47922129+01:00","closed_at":"2026-02-04T03:24:19.47922129+01:00","close_reason":"Implemented per-agent per-turn LLM routing via new LlmRouter service (openai/anthropic/gemini) using @effect/ai Model.make + provider layers. ArenaService now calls router using agent.llmProvider+agent.llmModel. Gate passes. Reviewer APPROVE.","dependencies":[{"issue_id":"agon-7fz","depends_on_id":"agon-3m6","type":"blocks","created_at":"2026-02-04T01:56:27.568016455+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-7fz","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:21.800787166+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-81x","title":"History sync: fetch thread messages each turn and persist to D1","description":"On each turn, fetch last N messages from Discord thread, transform into prompt, and upsert into D1 messages table (dedupe by discord_message_id). Ensure bots filtering rules are applied and human interruptions are captured.nnDoD:n- Consumer uses Discord thread history as contextn- D1 persists synced history with dedupen- Prompt built from synced messages + agent system promptn- gate passes","notes":"Implemented per-turn Discord thread history sync into D1. ArenaService.processTurn fetches recent thread messages; skips sync only when DISCORD_BOT_TOKEN is missing (otherwise fails turn for queue retry). Messages are classified (webhook_id =\u003e agent, author.bot =\u003e bot_other, else human) and upserted by discordMessageId with onConflictDoUpdate (edits supported). Prompt history is built from timestamp-sorted D1 messages with bot_other filtered and local-turn duplicates removed via time-window + agentId heuristic. History trimming is timestamp-based. npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T01:55:39.564885055+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:06:35.26811035+01:00","closed_at":"2026-02-04T04:06:29.273325921+01:00","close_reason":"Implemented per-turn Discord thread history sync into D1 and prompt builder; gate passes.","dependencies":[{"issue_id":"agon-81x","depends_on_id":"agon-04k","type":"blocks","created_at":"2026-02-04T01:56:37.736475044+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-81x","depends_on_id":"agon-3m6","type":"blocks","created_at":"2026-02-04T01:56:51.793360992+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-81x","depends_on_id":"agon-7fz","type":"blocks","created_at":"2026-02-04T01:57:01.958303961+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-81x","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T01:57:31.964256914+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-852","title":"Migrate to discord-interactions-js for interaction handling","description":"Replace custom Discord interaction verification and magic number constants with the official discord-interactions package.","design":"1. Add 'discord-interactions' npm package\n2. Replace custom verifyDiscordInteraction() in src/services/Discord.ts with verifyKey from discord-interactions\n3. Replace magic numbers in src/index.ts interaction handler:\n   - 1 → InteractionType.PING\n   - 2 → InteractionType.APPLICATION_COMMAND  \n   - 4 → InteractionResponseType.CHANNEL_MESSAGE_WITH_SOURCE\n   - 64 → InteractionResponseFlags.EPHEMERAL\n4. Keep APIInteraction type from discord-api-types/v10 (still needed for typing)\n5. Remove or deprecate the custom verifyDiscordInteraction export","acceptance_criteria":"- discord-interactions package installed and imports working\n- Interaction signature verification still works (verifyKey replaces custom implementation)\n- All interaction type/response/flag magic numbers replaced with enums\n- No TypeScript errors, gate passes\n- /discord/interactions endpoint still functions correctly","notes":"Consensus: Use discord-interactions package for verifyKey and enums. Replace magic numbers: 1→PING, 2→APPLICATION_COMMAND, 4→CHANNEL_MESSAGE_WITH_SOURCE, 64→EPHEMERAL. Keep discord-api-types for APIInteraction typing.","status":"open","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:14:27.564237534+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T12:48:18.837027548+01:00"}
{"id":"agon-8to","title":"Admin: queue metrics link + optional Cloudflare Analytics API","description":"Show queue health without duplicating CF:\n- Always: provide deep link(s) and a short explanation where to see queue depth/rate in Cloudflare dashboard.\n- Optional: if CF API token is provided, call Cloudflare GraphQL Analytics API to show queue depth/throughput/errors in UI.\n\nDoD:\n- Minimal UI widget + docs\n- Gate passes","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:13:13.870351237+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.359123118+01:00","closed_at":"2026-02-04T11:50:22.359123118+01:00","close_reason":"Implemented Metrics page with Cloudflare deep links + explainer (config via localStorage); no CF dashboard duplication."}
{"id":"agon-8vj","title":"DX: dev:all bootstrap secrets from environment","description":"Make `npm run dev:all` work on NixOS without editing `.dev.vars` or `packages/admin/.env`, assuming secrets are already present in the shell (vault).\n\nApproach:\n- scripts/wrangler-dev.mjs: if .dev.vars missing, generate it from process.env for known keys (0600 perms)\n- scripts/admin-dev.mjs: set VITE_ADMIN_TOKEN from ADMIN_TOKEN if missing, then run workspace vite\n- update package.json dev:admin to use wrapper\n\nDoD:\n- With env vars set, `npm run dev:all` starts worker + admin and admin calls succeed\n- No secrets passed on command line\n- gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:59:21.043325357+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T15:04:39.620180693+01:00","closed_at":"2026-02-04T15:04:39.620180693+01:00","close_reason":"Added wrappers so dev:all bootstraps .dev.vars from env (vault) without --var argv secrets and sets VITE_ADMIN_TOKEN from AGON_DEV_ADMIN_TOKEN (default devtoken); gate passes."}
{"id":"agon-9mx","title":"Gate fails: remove unused imports in src/index.ts (TS6133)","description":"npm run gate -\u003e typecheck fails with TS6133 unused imports in src/index.ts: and, inArray, or. This blocks verifying unrelated changes.","status":"open","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T14:41:57.665390097+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T14:41:57.665390097+01:00"}
{"id":"agon-9qy","title":"agon-4kb","description":"Implement Discord autocomplete interaction handling to allow fuzzy agent search when selecting agents for room creation or other commands.","design":"## Implementation Plan\n\n1. **Add autocomplete-enabled option to commands**\n   - In command definition, set `autocomplete: true` on agent selection options\n   - Example: `agents` option in `/agon room create`\n\n2. **Handle APPLICATION_COMMAND_AUTOCOMPLETE (type 4)**\n   - Check if incoming interaction type is 4 (autocomplete)\n   - Extract focused option value (what user typed)\n   - Query D1 for matching agents: `SELECT id, name, llm_model FROM agents WHERE name LIKE ?`\n   - Return up to 25 choices with format: `{name: Claude","acceptance_criteria":"- Typing in agent field triggers autocomplete dropdown\n- Selecting from dropdown passes correct agent_id to command handler\n- Search filters results as user types\n- Graceful fallback when no matches found\n- Response time \u003c 100ms (Discord recommends quick autocomplete)","notes":"Consensus: Must return within 3s (cannot defer). Query D1 agents table with LIKE filter on name. Return max 25 choices. Keep agent list cached in memory or use simple query for speed.","status":"open","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:20:11.865180642+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T12:48:18.874293194+01:00","dependencies":[{"issue_id":"agon-9qy","depends_on_id":"agon-4kb","type":"parent-child","created_at":"2026-02-05T12:20:24.325483301+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-aar","title":"GitHub OAuth login for admin UI","description":"Add GitHub OAuth authentication to protect the admin UI and API. Replace VITE_ADMIN_TOKEN with proper login flow.nnComponents:n- Worker auth endpoints (OAuth flow, JWT cookies)n- Serve admin UI from worker via CF static assetsn- Admin UI login page + auth guardn- requireAdmin accepts JWT cookie or Bearer token","status":"closed","priority":1,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T22:45:29.171867336+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T23:04:30.668634533+01:00","closed_at":"2026-02-04T23:04:30.668634533+01:00","close_reason":"All 3 tasks complete: OAuth endpoints, static assets, admin UI login"}
{"id":"agon-aar.1","title":"Worker auth endpoints (GitHub OAuth + JWT cookie)","description":"Add auth routes to the worker:nn- GET /auth/login → redirect to GitHub OAuth authorize URL (with state param for CSRF)n- GET /auth/callback → exchange code for GitHub token, fetch user info, check AUTH_ALLOWED_USERS, sign JWT, set httpOnly cookie, redirect to /n- GET /auth/me → decode JWT from cookie, return user infon- POST /auth/logout → clear cookiennJWT: HMAC-SHA256 with JWT_SECRET, contains {sub, login, avatar_url, exp (7d)}nCookie: httpOnly, Secure, SameSite=Lax, Path=/nnUpdate requireAdmin to accept JWT cookie OR Bearer token.nnNew env vars: GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET, JWT_SECRET, AUTH_ALLOWED_USERS","design":"- Use Web Crypto API for HMAC-SHA256 JWT signing (available in CF Workers)n- State param: random hex stored in short-lived cookie for CSRF protectionn- AUTH_ALLOWED_USERS: comma-separated GitHub logins; empty = any authenticated GitHub usern- Keep Bearer token auth as fallback for programmatic API access","notes":"Implemented /auth/login, /auth/callback, /auth/me, /auth/logout in src/index.ts; added HS256 WebCrypto JWT helpers in src/lib/jwt.ts; updated requireAdmin to accept Bearer ADMIN_TOKEN or session JWT cookie; added new env keys to Env + makeConfigLayer secretKeys. npm run gate passes.","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T22:45:36.086783485+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T23:04:30.570962925+01:00","closed_at":"2026-02-04T23:04:30.570962925+01:00","close_reason":"Implemented: OAuth endpoints, JWT cookies, requireAdmin dual-auth, allowlist per-request","dependencies":[{"issue_id":"agon-aar.1","depends_on_id":"agon-aar","type":"parent-child","created_at":"2026-02-04T22:45:36.087233815+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-aar.2","title":"Serve admin UI from worker via CF static assets","description":"Configure Cloudflare Workers static assets to serve the admin SPA from the same origin as the API.nnChanges:n- Add [assets] config to wrangler.toml pointing to packages/admin/distn- Add ASSETS binding to Env typen- At end of fetch handler, for unmatched non-API routes, serve /index.html from ASSETS (SPA fallback)n- Update build pipeline: build admin UI before wrangler deployn- Update vite config: remove /admin proxy (no longer needed in production)n- Add npm script for full build + deploy","design":"wrangler.toml:n[assets]ndirectory = \"./packages/admin/dist\"nbinding = \"ASSETS\"nnSPA fallback in worker:nif (!matchedRoute \u0026\u0026 env.ASSETS) return env.ASSETS.fetch(new Request(url.origin + '/index.html'))nnBuild order: build admin → wrangler deploy (assets included automatically)","notes":"Configured static assets: added [assets] binding ASSETS in wrangler.toml; added ASSETS to Env; worker serves env.ASSETS.fetch(request) + SPA fallback to /index.html; updated root package.json scripts build:admin + deploy; updated admin Vite proxy to include /auth. npm run gate passes.","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T22:45:43.178738648+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T23:04:30.604405434+01:00","closed_at":"2026-02-04T23:04:30.604405434+01:00","close_reason":"Implemented: CF static assets, SPA fallback, build:admin + deploy scripts","dependencies":[{"issue_id":"agon-aar.2","depends_on_id":"agon-aar","type":"parent-child","created_at":"2026-02-04T22:45:43.17922158+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-aar.3","title":"Admin UI login page + auth guard","description":"Update SolidJS admin UI with login flow:nn- Login page: centered card with GitHub logo + 'Login with GitHub' button that navigates to /auth/loginn- Auth guard: on app load, call GET /auth/me. If 401, show login page. If ok, show admin UI.n- Logout button in sidebar navn- Remove VITE_ADMIN_TOKEN dependency from api.ts (use cookie-based auth, credentials: 'same-origin')n- Show logged-in user avatar + name in sidebar","design":"- createResource for auth check on mountn- Show/Switch between Login and App based on auth staten- apiFetch: remove Authorization header logic, add credentials: 'same-origin'n- Logout: POST /auth/logout then reload","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T22:45:49.85787318+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T23:04:30.635031077+01:00","closed_at":"2026-02-04T23:04:30.635031077+01:00","close_reason":"Implemented: Login page, auth guard, cookie-based auth, user info sidebar, logout","dependencies":[{"issue_id":"agon-aar.3","depends_on_id":"agon-aar","type":"parent-child","created_at":"2026-02-04T22:45:49.858331435+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-ar2","title":"Admin API: auth + agents CRUD endpoints","description":"Add protected admin API endpoints in the worker to manage agents.\n\nDeliver:\n- Auth strategy: either Cloudflare Access (preferred) or ADMIN_TOKEN bearer.\n- Endpoints: GET/POST/PUT/DELETE /admin/agents\n- Validate payloads with Schema.\n- Persist to D1 agents table.\n\nDoD:\n- Endpoints covered by auth\n- Gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:12:55.041578077+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.143942546+01:00","closed_at":"2026-02-04T11:50:22.143942546+01:00","close_reason":"Implemented ADMIN_TOKEN auth + /admin/agents CRUD endpoints; gate passes."}
{"id":"agon-b5m","title":"Observability: structured Effect logging + Cloudflare correlation","description":"Add a baseline observability setup:\n- Structured JSON logging via Effect Logger (configurable LOG_LEVEL + LOG_FORMAT)\n- Correlation/annotations for HTTP requests (cf-ray, method, path) and queue turns (message.id, attempts, roomId, turnNumber)\n- Log spans for key operations (queue job, processTurn, discord sync, llm generate, webhook post)\n\nDoD:\n- Logs appear in Cloudflare (console) as structured JSON with annotations\n- Gate passes","notes":"Added baseline observability tied to Cloudflare logs:\n- New src/services/Observability.ts provides Effect Logger layer configured by LOG_LEVEL + LOG_FORMAT (json/logfmt/pretty), defaulting to json.\n- Runtime now includes Observability.layer.\n- HTTP handlers annotate logs with requestId (CF-Ray fallback UUID) + route and add log spans.\n- Queue consumer annotates logs with queue/message metadata (message.id, attempts, roomId, turnNumber) and adds spans; explicit Effect logs added in ArenaService.processTurn for major steps (discord sync, prompt build, llm generate, webhook post) without logging prompt/reply contents.\n- npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T04:57:36.566893793+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T05:06:38.707343986+01:00","closed_at":"2026-02-04T05:06:38.707343986+01:00","close_reason":"Implemented Effect-based structured logging + Cloudflare correlation; gate passes. Reviewer APPROVE."}
{"id":"agon-czz","title":"Hardening: make webhook posting idempotent on queue retries","description":"Address non-blocking review note: if queue retry happens after successful webhook post but before room state update, we can duplicate Discord messages. Add idempotency around Discord posting (e.g., persist a posted flag or store discord_message_id returned by webhook, or use Discord message dedupe when syncing history).nnDoD:n- Duplicate Discord posts prevented (or detected+ignored) across retriesn- Tested via simulated failure pathn- gate passes","notes":"Implemented webhook-post idempotency for queue retries: ArenaService.processTurn now skips Discord webhook posting on confirmed retries (existing local-turn message) when an equivalent non-local agent message already exists in recent D1 history (or Discord fetch) within the retry window. Gate passes.","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T03:12:39.021637676+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:51:10.863260473+01:00","closed_at":"2026-02-04T04:51:10.863260473+01:00","close_reason":"Added retry-safe Discord webhook posting (skip post when duplicate detected on confirmed retry); gate passes.","dependencies":[{"issue_id":"agon-czz","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T03:12:42.88812521+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-dao","title":"Admin API: rooms dashboard endpoints","description":"Expose read-only endpoints for rooms and room details.\n\nEndpoints:\n- GET /admin/rooms (status, topic, threadId, parentChannelId, currentTurn*, lastEnqueuedTurnNumber)\n- GET /admin/rooms/:id (include participants + recent messages)\n- POST /admin/rooms/:id/pause and /resume (optional)\n\nDoD:\n- Protected by admin auth\n- Gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:12:55.118753978+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.178448872+01:00","closed_at":"2026-02-04T11:50:22.178448872+01:00","close_reason":"Implemented /admin/rooms list + room detail endpoints; gate passes."}
{"id":"agon-dm4","title":"Admin UI: agents + rooms dashboard + observability links","description":"Build a simple internal admin UI (packages/admin) to manage Agents and monitor Rooms/Turns. Avoid duplicating Cloudflare dashboards; instead expose Agon-specific state from D1 and provide deep links / pointers to Cloudflare logs + queue metrics.\n\nScope:\n- Agents CRUD (provider/model/systemPrompt/avatar)\n- Rooms monitor (status, current turn, participants, threadId/parentChannelId)\n- Turn/event timeline for debugging (minimal internal telemetry)\n- External links to Cloudflare dashboards (logs, queue metrics)\n\nNon-goals:\n- Full log ingestion/replication of Cloudflare logs\n- Message-level queue inspection (not supported by CF Queues)\n\nDoD:\n- Admin UI can be protected (Access or ADMIN_TOKEN)\n- Gate passes","notes":"Planned tasks: agon-ar2 (admin auth+agents CRUD API), agon-tgg (agents UI), agon-dao (rooms dashboard API), agon-ysi (rooms monitor UI), agon-f02 (room creation + membership API), agon-18e (room composer UI), agon-5d6 (internal turn event timeline), agon-8to (queue metrics links/optional CF analytics).","status":"open","priority":1,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:12:44.865742092+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:13:18.358925902+01:00"}
{"id":"agon-edh","title":"Admin settings, extended agent config, Discord guilds page","description":"Three features:n1. Extended agent LLM config (temperature, maxTokens, thinking level/tokens) with per-provider validationn2. Settings page for API keys stored in D1 (encrypted), no redeployment neededn3. Discord guilds page showing where the bot is installed","status":"closed","priority":1,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T23:47:58.571707529+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T00:21:06.508247364+01:00","closed_at":"2026-02-05T00:21:06.508247364+01:00","close_reason":"All 3 tasks complete: agent LLM config, encrypted settings, Discord guilds"}
{"id":"agon-edh.1","title":"Extended agent LLM config with per-provider validation","description":"Add LLM generation params to agents table + form with per-provider validation.nnNew agent columns (all nullable = use provider defaults):n- temperature (real, 0.0-2.0)n- maxTokens (integer, \u003e0)n- thinkingLevel (text: 'low'|'medium'|'high' — OpenAI reasoning_effort / Anthropic extended thinking)n- thinkingBudgetTokens (integer, \u003e0 — Anthropic budget_tokens)nnProvider support matrix:n- OpenAI: temperature, maxTokens, thinkingLevel (reasoning_effort for o-series)n- Anthropic: temperature, maxTokens, thinkingLevel, thinkingBudgetTokensn- Gemini: temperature, maxTokensn- OpenRouter: temperature, maxTokens (passed through)nnAdmin UI: show/hide fields based on selected provider. Validate ranges client-side + server-side.nLlmRouter: pass these params when calling LLM APIs.nD1 migration for new columns.","design":"- Schema: nullable columns with no defaults (null = provider default)n- LlmRouter.generate: accept optional config, apply to each provider's APIn- OpenRouter: add temperature/max_tokens to chat completions bodyn- @effect/ai providers: pass via layer config or generateText optionsn- Admin UI: reactive show/hide per provider selection","notes":"Implemented extended per-agent LLM generation params (DB columns + migration), wired through LlmRouter (OpenRouter/OpenAI/Anthropic/Gemini), ArenaService pass-through, admin API validation + persistence, and admin UI form show/hide + submit normalization. Gate + tests pass.","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T23:48:09.60491368+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T00:21:06.41223983+01:00","closed_at":"2026-02-05T00:21:06.41223983+01:00","close_reason":"Implemented: temperature, maxTokens, thinkingLevel, thinkingBudgetTokens with per-provider validation","dependencies":[{"issue_id":"agon-edh.1","depends_on_id":"agon-edh","type":"parent-child","created_at":"2026-02-04T23:48:09.605392784+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-edh.2","title":"Settings page with encrypted API keys in D1","description":"Store API keys in D1 (encrypted) instead of env vars. Single ENCRYPTION_KEY in env, everything else in DB.nnNew D1 table: settings (key TEXT PK, value TEXT NOT NULL, updated_at_ms INTEGER)nEncryption: AES-256-GCM via Web Crypto, key derived from ENCRYPTION_KEY env var.nnKeys to manage:n- OPENAI_API_KEYn- OPENROUTER_API_KEYn- ANTHROPIC_API_KEYn- GOOGLE_AI_API_KEYn- DISCORD_BOT_TOKENn- OPENROUTER_HTTP_REFERERn- OPENROUTER_TITLEnnWorker: read from D1 settings first, fall back to env vars (backwards compat).nLlmRouter + Discord: resolve API keys from settings service.nnAdmin UI: Settings page with form per key (masked input, save button, 'configured' badge).nAPI: GET /admin/settings (list keys, values masked), PUT /admin/settings/:key (encrypt + store).","design":"- src/services/Settings.ts: Effect service, encrypt/decrypt with AES-GCM, getKey(name) → Redactedn- Migration: CREATE TABLE settingsn- LlmRouter: inject Settings service, try DB key first, env fallbackn- Discord: same patternn- Admin UI: Settings page with key names, masked values, edit/save per keyn- Never expose raw keys in API responses (show last 4 chars only)","notes":"Implemented encrypted settings in D1: added settings table + migration, AES-256-GCM crypto helpers, Settings Effect service, /admin/settings routes (GET/PUT/DELETE), admin UI Settings page, and wired LlmRouter + Discord to resolve tokens via Settings with env fallback. Added ENCRYPTION_KEY to Env + config + AGENTS.md. Gate + tests passing.","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T23:48:20.473286467+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T00:21:06.44117693+01:00","closed_at":"2026-02-05T00:21:06.44117693+01:00","close_reason":"Implemented: encrypted settings in D1, Settings service, admin UI settings page","dependencies":[{"issue_id":"agon-edh.2","depends_on_id":"agon-edh","type":"parent-child","created_at":"2026-02-04T23:48:20.473758638+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-edh.3","title":"Discord guilds page (where is the bot installed)","description":"Admin page showing which Discord servers the bot is in.nnBackend: GET /admin/discord/guilds → calls Discord API GET /users/@me/guilds with bot token → returns list of guilds.nResponse: array of { id, name, icon, permissions, owner }.nIcon URL: https://cdn.discordapp.com/icons/{id}/{icon}.pngnnAdmin UI: Guilds page with server cards showing icon + name.nAdd nav link in sidebar.","design":"- Worker: new admin route, uses Discord bot token (from Settings or env)n- Discord service: add getGuilds() methodn- Admin UI: new page packages/admin/src/pages/Guilds.tsxn- Display as card grid with server icons and names","notes":"Implemented Discord guilds page: added Discord.getGuilds(), new admin route GET /admin/discord/guilds, SolidJS Guilds page + sidebar link + CSS, added discordApi.guilds client. npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T23:48:29.399957713+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T00:21:06.473056089+01:00","closed_at":"2026-02-05T00:21:06.473056089+01:00","close_reason":"Implemented: Discord.getGuilds(), admin route, guilds page with server cards","dependencies":[{"issue_id":"agon-edh.3","depends_on_id":"agon-edh","type":"parent-child","created_at":"2026-02-04T23:48:29.400495619+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-eys","title":"DX: preconfigure Cloudflare dashboard link vars in wrangler.toml","description":"Metrics page pulls CF dashboard links from /admin/meta. Make it zero-config by setting CF_* vars in wrangler.toml [vars] (and optionally account_id).\n\nDoD:\n- wrangler.toml includes CF_ACCOUNT_ID/CF_WORKER_SERVICE/CF_QUEUE_NAME/CF_D1_NAME defaults\n- AGENTS.md no longer tells user to set CF_* manually\n- gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T13:51:32.111938865+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T13:53:39.580868827+01:00","closed_at":"2026-02-04T13:53:39.580868827+01:00","close_reason":"Set CF_* vars and account_id in wrangler.toml; removed manual CF_* step from AGENTS; gate passes."}
{"id":"agon-f02","title":"Admin API: room creation + membership management","description":"Expose admin endpoints to create/restart rooms and manage room_agents.\n\nEndpoints (suggested):\n- POST /admin/rooms (parentChannelId, threadId? or create thread? topic, autoArchiveDurationMinutes, agentIds+turnOrder)\n- PUT /admin/rooms/:id/participants\n\nDoD:\n- Protected by admin auth\n- Uses existing ArenaService.createRoom/upsert logic\n- Gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:13:13.805699707+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.22584146+01:00","closed_at":"2026-02-04T11:50:22.22584146+01:00","close_reason":"Implemented /admin/rooms create (thread+webhook as needed) and pause/resume; enqueues first job; gate passes."}
{"id":"agon-gr3","title":"Turn loop reliability: self-healing debate progression","description":"Every failure mode in the turn loop is terminal - processTurn returns null and the chain dies forever. No watchdog, no cron, no self-recovery. User must manually kick every time. Six distinct failure points all result in permanent loop death: LLM failure, webhook post failure, audience slot job loss, room status drift, turn number drift, and CF Queue message exhaustion.","status":"open","priority":0,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T14:35:33.284718436+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T14:35:33.284718436+01:00"}
{"id":"agon-gr3.1","title":"Make processTurn failure-resilient: webhook and LLM failures must not kill the loop","description":"In ArenaService.processTurn, both LLM failure and webhook post failure return null after retries, permanently killing the turn chain. The loop never self-recovers.","design":"Two changes in src/services/ArenaService.ts processTurn method:nn1. WEBHOOK POST FAILURE (around the webhook posting block):n- The LLM reply is ALREADY saved to D1 before Discord posting happensn- If webhook post fails, log the error, send the notification, but DO NOT return nulln- Instead, fall through to the normal turn-advance logic (advance currentTurnNumber, pick next agent, return next TurnJob)n- The reply is safely in D1 and will sync to Discord on next turn's discord sync phasenn2. LLM FAILURE (around the llmResult Either.isLeft block):n- When LLM fails after retries, currently returns null (loop dies)n- Instead: skip this agent's turn, advance to next agent, return next TurnJobn- Still post the failure notification to Discord (best effort)n- Still write the turn event with phase=finish, status=failn- But return { type: 'turn', roomId, turnNumber: job.turnNumber + 1 } instead of nulln- Update room state (currentTurnNumber, currentTurnAgentId) to advance past the failed agentn- This way if one provider is down, other agents with different providers can still take their turnsnnBoth changes follow the same principle: the loop must continue. Notify about failure, but don't stop.","acceptance_criteria":"- Webhook post failure: loop continues to next turn, reply persists in D1n- LLM failure: loop skips to next agent, other agents still get their turnsn- Failure notifications still posted to Discord (best effort)n- Turn events still recorded for observabilityn- No behavioral change for success pathn- Gate passes","notes":"Implemented failure-resilient processTurn in src/services/ArenaService.ts (LLM failure skips to next agent; webhook post failure no longer returns null). Updated turnFailedNotification. Note: npm run gate currently fails due to unused imports (and/inArray/or) in src/index.ts (TS6133), unrelated to this change and outside allowed file scope.","status":"closed","priority":0,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T14:35:47.316042695+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T14:44:20.639394772+01:00","closed_at":"2026-02-05T14:44:20.639394772+01:00","close_reason":"Implemented: LLM failure skips to next agent, webhook failure continues loop. Gate passes.","dependencies":[{"issue_id":"agon-gr3.1","depends_on_id":"agon-gr3","type":"parent-child","created_at":"2026-02-05T14:35:47.317461413+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-gr3.2","title":"Add CF Cron watchdog for stalled rooms","description":"There is no mechanism to detect and recover stalled rooms. If the turn chain breaks for any reason (queue message lost, crash between DB write and queue ack, audience_slot job dropped, unexpected status), the room stays stuck forever until a human kicks it.","design":"Add a Cloudflare Scheduled Handler (cron trigger) that runs every 60 seconds and self-heals stalled rooms.nnFiles to modify:n- wrangler.toml: add [triggers] crons = ['* * * * *'] (every minute)n- src/index.ts: add scheduled() export handlernnScheduled handler logic:n1. Query all rooms where status IN ('active', 'audience_slot')n2. For each room, check the last message timestamp from D1n3. If last message is older than STALL_THRESHOLD (e.g. 120 seconds for active, audienceSlotDurationSeconds + 60 for audience_slot):n   a. Compute nextTurnNumber = currentTurnNumber + 1n   b. If lastEnqueuedTurnNumber \u003e= nextTurnNumber, skip (job already enqueued)n   c. Otherwise enqueue { type: 'turn', roomId, turnNumber: nextTurnNumber }n   d. Update lastEnqueuedTurnNumbern   e. If room was in audience_slot, set status back to 'active' firstn4. Log all recovery actions for observabilitynnFor audience_slot rooms specifically:n- The close_audience_slot delayed job may have been lostn- If stall time exceeds audienceSlotDurationSeconds + buffer, transition to active and enqueue next turnnnKeep it simple: query rooms, check staleness, re-enqueue. The existing processTurn handles idempotency so double-enqueue is safe.","acceptance_criteria":"- Cron trigger configured in wrangler.toml (every 60s)n- scheduled() handler queries stalled active/audience_slot roomsn- Stalled rooms get their next turn re-enqueued automaticallyn- Idempotent: safe to run even when nothing is stalledn- Logs recovery actionsn- audience_slot rooms recovered after their duration expiresn- Gate passes","notes":"Implemented cron-based stall watchdog: wrangler cron every minute + scheduled handler that scans active/audience_slot rooms, checks last message max(createdAtMs), and re-enqueues next turn when stalled (updates status/lastEnqueuedTurnNumber). Gate passes.","status":"in_progress","priority":0,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T14:36:01.64172328+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T14:42:15.257067631+01:00","dependencies":[{"issue_id":"agon-gr3.2","depends_on_id":"agon-gr3","type":"parent-child","created_at":"2026-02-05T14:36:01.64329978+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-ise","title":"OpenRouter: implement provider routing","description":"Implement OpenRouter provider in LlmRouter (OpenAI-compatible baseUrl). Add OPENROUTER_API_KEY config and header support.\n\nDoD:\n- LlmProviderSchema includes openrouter\n- LlmRouter uses OpenAiClient with baseUrl https://openrouter.ai/api/v1\n- Config reads OPENROUTER_API_KEY\n- gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:10:45.775817049+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T14:17:33.358718691+01:00","closed_at":"2026-02-04T14:17:33.358718691+01:00","close_reason":"Implemented OpenRouter provider in LlmRouter using OpenAiClient apiUrl https://openrouter.ai/api/v1 + optional headers; reads OPENROUTER_API_KEY; gate passes."}
{"id":"agon-iwm","title":"Admin UI: remove diary-style copy from Metrics page","description":"Metrics page has a fluffy paragraph explaining what it is not. Replace with direct, actionable copy (what this page does) and keep it concise.\n\nDoD:\n- Remove 'intentionally does not replicate...' phrasing\n- Replace with 1-2 sentences describing what the page provides\n- gate passes","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T13:42:47.730833642+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T13:45:13.962730235+01:00","closed_at":"2026-02-04T13:45:13.962730235+01:00","close_reason":"Superseded by task to remove manual Cloudflare accountId config from Metrics page and fetch links from worker env."}
{"id":"agon-m6k","title":"Admin UI: Metrics links from worker env (no accountId form)","description":"Make Metrics page production-grade: no manual accountId/service/db/queue entry in UI.\n\nApproach:\n- Add /admin/meta endpoint returning Cloudflare dashboard deep links computed from worker env vars.\n- Admin UI fetches /admin/meta and renders links.\n- If not configured, show a short error with exact env var names to set.\n\nConfig env vars (optional):\n- CF_ACCOUNT_ID (required for links)\n- CF_WORKER_SERVICE (default: agon)\n- CF_QUEUE_NAME (default: arena-turns)\n- CF_D1_NAME (default: agon-db)\n\nDoD:\n- Metrics page has no inputs/localStorage\n- Links work when env vars set\n- gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T13:45:18.568255151+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T13:49:33.710531894+01:00","closed_at":"2026-02-04T13:49:33.710531894+01:00","close_reason":"Removed Metrics UI inputs/localStorage; added /admin/meta that returns Cloudflare deep links from worker env vars; updated AGENTS.md; gate passes."}
{"id":"agon-mn3","title":"Chore: configure git remote and push","description":"Set git remote origin, push current branch, and confirm repo is up to date with origin. Blocked until remote URL is provided.nnDoD:n- origin remote configuredn- git push succeedsn- git status shows up to date","notes":"Remote URL received: git@github.com:extropy-club/agon.git. Will set origin and push current branch (master).","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T04:52:21.579632952+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:08:29.12147485+01:00","closed_at":"2026-02-04T11:08:29.12147485+01:00","close_reason":"Configured origin (git@github.com:extropy-club/agon.git) and pushed master to GitHub."}
{"id":"agon-ofg","title":"Fix: ConfigProvider reads non-enumerable env vars (secrets)","description":"Wrangler/Workers env secrets may be non-enumerable so makeConfigLayer(Object.entries) misses them. This breaks Config.redacted lookups (ADMIN_TOKEN, DISCORD_BOT_TOKEN, API keys).\n\nDoD:\n- makeConfigLayer extracts string values using Object.getOwnPropertyNames / Reflect.ownKeys\n- Admin endpoints accept ADMIN_TOKEN from .dev.vars / secrets\n- Quick smoke test with curl shows /admin/agents returns 401 without auth and 200 with auth\n- gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T13:07:30.303259675+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T13:19:16.730342453+01:00","closed_at":"2026-02-04T13:19:16.730342453+01:00","close_reason":"Fixed ConfigProvider env mapping to include secrets/non-enumerable keys; admin endpoints now return 401/200 as expected; gate passes."}
{"id":"agon-q7z","title":"Admin: add room kick endpoint + UI button","description":"Local dev can lose queue messages on restart while rooms.lastEnqueuedTurnNumber persists, leaving rooms stuck (currentTurnNumber \u003c lastEnqueuedTurnNumber). Add an explicit admin 'kick' action to enqueue the next turn regardless of lastEnqueued marker, and expose a button in Room detail UI.\n\nDoD:\n- POST /admin/rooms/:id/kick enqueues {roomId, turnNumber=currentTurnNumber+1}\n- RoomDetail UI shows 'Kick next turn' button (visible when room active)\n- gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T15:11:01.060535308+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T15:29:14.606978996+01:00","closed_at":"2026-02-04T15:29:14.606978996+01:00","close_reason":"Added /admin/rooms/:id/kick (stale-only) and RoomDetail Kick button with UI error handling; gate passes."}
{"id":"agon-rui","title":"Admin UI: take token from Vite .env (remove token form)","description":"Stop requiring manual token input in the admin UI. For local dev, read ADMIN token from Vite env (.env) and provide an example env file.\n\nDoD:\n- packages/admin reads token from import.meta.env.VITE_ADMIN_TOKEN in dev\n- Add packages/admin/.env.example with VITE_ADMIN_TOKEN and notes\n- UI no longer shows token input/Save; API uses env token (fallback optional)\n- Docs updated (AGENTS.md)\n- gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T13:23:27.397950965+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T13:32:14.645352727+01:00","closed_at":"2026-02-04T13:32:14.645352727+01:00","close_reason":"Admin UI token now comes from packages/admin/.env (VITE_ADMIN_TOKEN) with .env.example; removed token sidebar UI; added gitignore + docs warning; gate + admin checks pass."}
{"id":"agon-rxp","title":"Hardening: queue ack/send semantics","description":"Address non-blocking review note: current queue consumer acks message even if sending next job fails (ctx.waitUntil). Consider awaiting enqueue or making it part of the Effect pipeline with retries.nnDoD:n- Reliable enqueue semantics for next turnn- gate passes","notes":"Hardened queue ack/send semantics: queue consumer now awaits ARENA_QUEUE.send(next) before ack; on failure it calls message.retry with backoff. Added rooms.lastEnqueuedTurnNumber (migration 0001) and updates it after successful enqueue so redelivered messages don't re-enqueue duplicates; ArenaService retry path uses it. Gate passes.","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T03:12:39.085795971+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T04:51:10.892810284+01:00","closed_at":"2026-02-04T04:51:10.892810284+01:00","close_reason":"Queue now awaits enqueue before ack, retries explicitly on failure, and persists lastEnqueuedTurnNumber to avoid duplicate re-enqueues; gate passes.","dependencies":[{"issue_id":"agon-rxp","depends_on_id":"agon-1e3","type":"relates-to","created_at":"2026-02-04T03:12:50.16743515+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t0u","title":"Fix: sanitize DISCORD_BOT_TOKEN (strip Bot/Bearer prefixes)","description":"Discord API requests are failing 401; token may be stored with a 'Bot ' prefix or other wrapper. Harden token handling.\n\nDoD:\n- Discord.ts sanitizeToken strips surrounding quotes and leading 'Bot ' / 'Bearer '\n- wrangler-dev.mjs sanitize does same when writing .dev.vars\n- gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T15:41:50.077722324+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T15:46:22.972978739+01:00","closed_at":"2026-02-04T15:46:22.972978739+01:00","close_reason":"Hardened DISCORD_BOT_TOKEN sanitization (strip quotes + Bot/Bearer prefixes) in Discord service and dev wrapper; gate passes."}
{"id":"agon-t32","title":"Multi-agent debate system v2","description":"Refactor the debate arena to support proper multi-agent attribution, audience participation, and turn-based flow with Discord thread locking.\n\nKey changes from v1:\n- Agent systemPrompt = pure persona (no injected rules)\n- Room has title + topic + configurable limits\n- All messages use XML attribution in prompt (not stored, constructed at prompt-build time)\n- authorType enum: moderator | agent | audience | notification\n- Discord thread locking during agent turns\n- Audience slots after full agent cycle\n- Token limits: per-audience-message (4k default) + per-room max\n\nNon-goals (yet):\n- /debate Discord command (Admin UI only)\n- Context compaction (just stop at limit)","design":"Implementation phases:\n1. The Brain: Schema, Prompt Builder (XML wrap), LLM integration\n2. The Bridge: Manual /next command, Discord sync, webhook posting\n3. The Gavel: Thread lock/unlock, zombie recovery endpoint\n4. The Clock: Automated timers, audience slot triggers\n\nPrompt structure:\n- system: pure agent persona\n- user: \u003cmessage author=\"Moderator\" audience=\"false\"\u003etitle + topic + rules\u003c/message\u003e\n- user: \u003cmessage author=\"AgentName\" audience=\"false\"\u003econtent\u003c/message\u003e\n- user: [multiple text parts for audience] \u003cmessage author=\"Nick\" audience=\"true\"\u003econtent\u003c/message\u003e\n\nToken counting:\n- audienceTokenLimit (default 4k): max tokens for composed audience message (from last agent msg including)\n- roomTokenLimit: total conversation limit, room stops when reached","acceptance_criteria":"- Agents see proper attribution (who said what) via XML in prompt\n- Audience can participate during designated slots\n- Thread locked during agent processing\n- Room stops at token limit\n- Gate passes\n- Manual flow works end-to-end before automation","status":"closed","priority":1,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:31:10.424003071+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T22:40:17.369268353+01:00","closed_at":"2026-02-04T22:40:17.369268353+01:00","close_reason":"All 14 tasks complete: schema, prompt builder, token counting, Discord sync, moderator messages, admin UI, thread lock/unlock, zombie recovery, retry/backoff, slash commands, automated turn cycle, audience slots, rate limits, slot notifications"}
{"id":"agon-t32.1","title":"Phase 1: Schema updates for debate v2","description":"Update D1 schema to support new debate system requirements.\n\nChanges needed:\n- rooms: add title (text), audienceSlotDurationSeconds (int, default 30), audienceTokenLimit (int, default 4096), roomTokenLimit (int, default 32000)\n- messages.authorType: change enum from [human, agent, bot_other] to [moderator, agent, audience, notification]\n- agents.systemPrompt: ensure it's pure persona (document this, no code change needed)","design":"- Add columns to rooms table via Drizzle migration\n- Update authorType enum (will need data migration if existing rows)\n- Default values: audienceSlotDurationSeconds=30, audienceTokenLimit=4096, roomTokenLimit=32000\n- Update TypeScript types in packages/types if shared","acceptance_criteria":"- Migration generated and applies cleanly\n- Schema has new columns with defaults\n- authorType enum updated\n- Gate passes","notes":"Added data migration to migrations/0003_fixed_the_professor.sql to remap existing messages.author_type values: human→audience and bot_other→notification. Reset local Miniflare D1 state and re-applied migrations (0000-0003) successfully. Ran npm run gate.","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:31:31.379533909+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T17:58:40.800387028+01:00","closed_at":"2026-02-04T17:58:40.800387028+01:00","close_reason":"Schema updated: rooms columns + authorType enum + data migration. Gate passes.","dependencies":[{"issue_id":"agon-t32.1","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:31:31.380067147+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.10","title":"Phase 3: Retry with exponential backoff","description":"Implement proper retry logic for LLM and Discord API calls.\n\nRequirements:\n- Max 3 retries\n- Exponential backoff\n- Post notification on failure after retries exhausted","design":"- Use Effect.retry with Schedule.exponential\n- Apply to: LLM generate, Discord webhook post, Discord lock/unlock\n- On final failure: post notification to thread, mark turn as failed in events\n- Don't retry on non-retryable errors (auth, validation)","acceptance_criteria":"- Transient failures retried up to 3 times\n- Backoff between retries (exponential)\n- Final failure posts notification to Discord\n- Turn event logged with failure status\n- Gate passes","notes":"Implemented retryWithBackoff helper (1s/2s/4s, maxRetries=3, retryable predicate). Applied retries in ArenaService for llmRouter.generate, DiscordWebhookPoster.post, and Discord.lockThread/unlockThread; non-retryable auth/validation statuses excluded. On final failure after retries, posts Discord notification ('⚠️ Turn failed after retries. Please use /kick to restart.'), logs TurnEvent phase final_failure_notify + finish fail, and returns null to stop queue auto-retry (manual /kick can restart). Removed internal retry from LlmRouter to keep overall retries bounded. Gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:32:12.455564346+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T20:07:12.020016743+01:00","closed_at":"2026-02-04T20:07:12.020016743+01:00","close_reason":"Implemented: retryWithBackoff helper, applied to LLM/Discord calls, final failure notification","dependencies":[{"issue_id":"agon-t32.10","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:32:12.456023493+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.11","title":"Phase 3: Discord slash commands (/next, /stop, /audience, /continue)","description":"Implement Discord slash commands for manual room control.\n\nCommands:\n- /next - trigger next turn manually (for testing or manual mode)\n- /stop - pause the room\n- /audience - manually open audience slot\n- /continue - close audience slot and resume agents","design":"- Register slash commands with Discord API\n- Interaction endpoint in Worker\n- /next: enqueue next turn job\n- /stop: set room status to paused, unlock thread\n- /audience: unlock thread, set room in audience_slot state\n- /continue: lock thread, enqueue next turn\n- Commands only work in threads with active rooms","acceptance_criteria":"- All 4 commands registered and working\n- Commands respond with appropriate feedback\n- Invalid usage (wrong channel, no room) handled gracefully\n- Gate passes","notes":"Implemented Discord slash command handling in src/index.ts for /next, /stop, /audience, /continue with ephemeral responses, room/thread validation, D1 updates (pause/resume, lastEnqueuedTurnNumber) and queue enqueue. Added scripts/discord/registerCommands.mjs + docs/discord-slash-commands.md and package.json script discord:register-commands. npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:32:12.487838411+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T20:28:33.066870572+01:00","closed_at":"2026-02-04T20:28:33.066870572+01:00","close_reason":"Implemented: Discord slash commands /next, /stop, /audience, /continue with background lock/unlock","dependencies":[{"issue_id":"agon-t32.11","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:32:12.488342093+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-t32.11","depends_on_id":"agon-t32.8","type":"blocks","created_at":"2026-02-04T17:32:48.606974327+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.12","title":"Phase 4: Automated turn cycle with audience slots","description":"Automate the turn cycle: agent_1 -\u003e agent_2 -\u003e ... -\u003e agent_n -\u003e audience_slot -\u003e repeat\n\nRequirements:\n- After last agent in order completes, open audience slot\n- Audience slot duration from room.audienceSlotDurationSeconds\n- If duration = 0, skip automatic slot (manual /audience only)\n- After slot closes, continue with agent_1","design":"- Track cycle position (which agent, or audience slot)\n- After processTurn completes for last agent: \n  - If audienceSlotDurationSeconds \u003e 0: schedule audience slot close\n  - Else: immediately enqueue next turn\n- Use Queue delayed message or Durable Object alarm for timing\n- Recommendation: Queue with delay is simpler, use that first","acceptance_criteria":"- Full cycle runs automatically\n- Audience slot opens after all agents speak\n- Slot duration respected\n- 0 duration skips auto slot\n- Manual commands still work\n- Gate passes","notes":"Implemented automated audience slot cycle. Added RoomTurnJob union (turn | close_audience_slot with delaySeconds), processTurn now opens audience slot after last agent when audienceSlotDurationSeconds\u003e0 and returns delayed close job. Queue handler handles close_audience_slot jobs (lock thread, set status active, enqueue next turn) and sends delayed messages. Added room status 'audience_slot' to schema + admin UI types/CSS. Improved processTurn redelivery: when room in audience_slot, re-enqueues close job. Gate passes. Also fixed type errors in src/services/Discord.ts by widening error type in requestJson.","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:32:28.180767489+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T22:26:10.417602454+01:00","closed_at":"2026-02-04T22:26:10.417602454+01:00","close_reason":"Implemented: Automated turn cycle with audience slots, delayed queue jobs, redelivery-safe","dependencies":[{"issue_id":"agon-t32.12","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:32:28.181262675+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-t32.12","depends_on_id":"agon-t32.11","type":"blocks","created_at":"2026-02-04T17:32:48.640533317+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.13","title":"Phase 4: Audience slot notifications","description":"Post notifications when audience slot opens/closes.\n\nMessages:\n- Slot open: '💬 Audience slot open ({N}s) - share your thoughts!'\n- Slot close: '🔒 Audience slot closed - debate continues'\n- Include next agent name when closing","design":"- Post as bot direct message (authorType = notification)\n- On slot open: unlock thread, post notification\n- On slot close: post notification, lock thread, enqueue next turn\n- If no audience messages during slot, still continue normally","acceptance_criteria":"- Notifications visible in Discord\n- Correct timing (appear at slot boundaries)\n- Filtered from LLM prompt\n- Gate passes","notes":"Implemented audience slot OPEN/CLOSE notifications:\n- OPEN: ArenaService.processTurn posts bot message and inserts D1 messages row (authorType=notification, authorName=System) after switching room to audience_slot + unlocking thread.\n- CLOSE: queue close_audience_slot handler posts bot message (includes next agent name) + inserts D1 notification row before locking thread / returning next turn.\n- Added messages.authorName (author_name) column + migration 0004_sour_red_skull.sql.\n- npm run gate passes.","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:32:28.22717643+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T22:40:17.332814965+01:00","closed_at":"2026-02-04T22:40:17.332814965+01:00","close_reason":"Implemented: slot open/close notifications, authorName column, best-effort Discord posting","dependencies":[{"issue_id":"agon-t32.13","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:32:28.227756748+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-t32.13","depends_on_id":"agon-t32.12","type":"blocks","created_at":"2026-02-04T17:32:48.673546764+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.14","title":"Phase 4: Handle Discord rate limits","description":"Gracefully handle Discord API rate limits (429 responses).\n\nConcern: Frequent lock/unlock cycles may hit rate limits.","design":"- Check X-RateLimit-* headers from Discord responses\n- If rate limited, wait and retry (respect Retry-After header)\n- Consider: batch operations where possible\n- Consider: if rate limits severe, keep thread locked longer (reduce unlock frequency)\n- Log rate limit events for monitoring","acceptance_criteria":"- 429 responses handled gracefully\n- Retry-After respected\n- No crashes due to rate limits\n- Rate limit events logged\n- Gate passes","notes":"Review: 429 detection uses status===429 + Retry-After/body retry_after/Reset-After fallback; retryWithBackoff honors getRetryAfterMs; proactive remaining==0 waits reset-after; retries bounded (maxRetries=3). Gate passes. No issues found.","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:32:28.259180449+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T22:26:10.448318696+01:00","closed_at":"2026-02-04T22:26:10.448318696+01:00","close_reason":"Implemented: Discord 429 handling with DiscordRateLimited, Retry-After respect, proactive rate limit check","dependencies":[{"issue_id":"agon-t32.14","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:32:28.259643704+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.2","title":"Phase 1: Prompt builder with XML attribution","description":"Create prompt builder that wraps stored messages in XML for LLM context.\n\nRequirements:\n- System message: pure agent persona (no rules injection)\n- First user message: Moderator message with title + topic + rules\n- All history messages wrapped: \u003cmessage author=\"Name\" audience=\"bool\"\u003econtent\u003c/message\u003e\n- Audience messages: multiple text parts in content array\n- Must escape XML special chars in content to prevent injection","design":"- New module: src/lib/promptBuilder.ts\n- buildPrompt(room, agent, messages) -\u003e Prompt.RawInput\n- XML escaping: escape \u003c, \u003e, \u0026 in message content before wrapping\n- Moderator message generated from room.title + room.topic\n- Rules hardcoded for now (can extract to config later)\n- Audience batching: group consecutive audience messages into single user message with multiple text parts","acceptance_criteria":"- Prompt builder produces correct XML structure\n- Agent's own messages and other agents' messages both use role: user with XML attribution\n- Audience messages batched as multiple text parts\n- XML injection prevented (escaped content)\n- Unit tests for prompt builder\n- Gate passes","notes":"Fix: escapeXmlAttribute added (escapes \u0026, \u003c, \u003e, \" and ') and applied to authorName in XML author=\"...\". Added unit test for authorName escaping. Ran npm run test + npm run gate (both pass).","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:31:31.41347054+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T17:58:40.829777654+01:00","closed_at":"2026-02-04T17:58:40.829777654+01:00","close_reason":"Prompt builder implemented with XML attribution, escaping, batching, and tests. Gate passes.","dependencies":[{"issue_id":"agon-t32.2","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:31:31.413970404+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.3","title":"Phase 1: Token counting for limits","description":"Implement token counting to enforce audienceTokenLimit and roomTokenLimit.\n\nRequirements:\n- Count tokens for audience message composition (from last agent message, including it)\n- Truncate audience parts if exceeds audienceTokenLimit\n- Track total room token usage\n- Stop room when roomTokenLimit reached","design":"- Use tiktoken or simple word-based estimation (tiktoken preferred if available)\n- countTokens(text: string) -\u003e number\n- truncateAudienceMessage(messages, limit) -\u003e truncated messages + warning if truncated\n- checkRoomLimit(room, totalTokens) -\u003e boolean (should stop)\n- Store running token count? Or calculate each turn from history?\n- Recommendation: calculate each turn (simpler, no drift)","acceptance_criteria":"- Token counting function works\n- Audience messages truncated when exceeding audienceTokenLimit\n- Room stops (status: completed) when roomTokenLimit reached\n- Notification posted when room stops due to limit\n- Gate passes","notes":"Updated tokenCounter: truncateAudienceParts now generic over TextPartLike (works with Prompt.TextPartEncoded from promptBuilder). Made heuristic fallback more conservative for dense/CJK text (len/3, words*1.5). Gate passes.","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:31:31.44611905+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T17:58:40.859532444+01:00","closed_at":"2026-02-04T17:58:40.859532444+01:00","close_reason":"Token counting implemented with TextPartLike generic and conservative heuristic. Gate passes.","dependencies":[{"issue_id":"agon-t32.3","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:31:31.446612492+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.4","title":"Phase 2: Discord sync with new authorType","description":"Update Discord sync to classify messages with new authorType enum.\n\nClassification:\n- Webhook messages (agent avatars): authorType = agent\n- Bot's own messages: authorType = notification  \n- Human messages: authorType = audience\n- Moderator message: authorType = moderator (posted at room creation)","design":"- Update sync logic in ArenaService to use new enum values\n- Bot's own user ID needed to distinguish notification from audience\n- Consider: store bot user ID in config or fetch once at startup\n- Moderator message created separately at room creation, not via sync","acceptance_criteria":"- Synced messages have correct authorType\n- Notifications filtered from prompt (existing logic, just new enum value)\n- No regression in existing sync functionality\n- Gate passes","notes":"Implemented Discord sync classification for new authorType with bot user ID detection. Added Discord.getBotUserId (prefers DISCORD_BOT_USER_ID, else fetches /users/@me with in-isolate cache) and updated ArenaService sync to classify: webhook→agent, bot self→notification, others→audience. Moderator bootstrap message stays authorType=moderator. Prompt builder continues filtering authorType=notification. Added DISCORD_BOT_USER_ID to Env passthrough. npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:31:51.945031159+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T18:25:53.778510222+01:00","closed_at":"2026-02-04T18:25:53.778510222+01:00","close_reason":"Implemented: Discord sync with new authorType, getBotUserId(), webhook→agent, bot→notification, else→audience","dependencies":[{"issue_id":"agon-t32.4","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:31:51.945489955+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-t32.4","depends_on_id":"agon-t32.1","type":"blocks","created_at":"2026-02-04T17:32:48.416308111+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.5","title":"Phase 2: Post moderator message on room creation","description":"When room is created, post the moderator message (title + topic + rules) to Discord thread.\n\nRequirements:\n- Posted visibly in thread so users see the debate topic\n- Stored in D1 with authorType = moderator\n- Appears as first message in prompt for all agents","design":"- After room created and thread exists, post via bot (not webhook)\n- Or: create special 'Moderator' webhook for consistent styling?\n- Store in messages table with authorType = moderator\n- Content: formatted title, topic, and rules","acceptance_criteria":"- Room creation posts moderator message to Discord\n- Message visible in thread\n- Stored in D1 as authorType = moderator\n- Appears first in prompt builder output\n- Gate passes","notes":"Implemented moderator message on room creation: ArenaService.createRoom now fetches thread name, posts formatted moderator message via Discord bot, and persists it to D1 with authorType=moderator. Discord service gained fetchChannelName + postMessage endpoints. Discord sync now classifies bot-posted moderator messages as moderator. Prompt builder no longer prepends its own moderator message when a persisted moderator message exists. Gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:31:51.977292811+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T18:25:53.808431768+01:00","closed_at":"2026-02-04T18:25:53.808431768+01:00","close_reason":"Implemented: Moderator message on room creation, fetchChannelName(), postMessage(), best-effort posting","dependencies":[{"issue_id":"agon-t32.5","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:31:51.977754252+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.6","title":"Phase 2: Integrate prompt builder into ArenaService","description":"Replace current prompt construction in ArenaService with new prompt builder.\n\nCurrent: inline construction with assistant/user roles\nNew: use promptBuilder.buildPrompt() with XML attribution","design":"- Import promptBuilder in ArenaService\n- Replace prompt construction block with buildPrompt(room, agent, history)\n- Ensure agent.systemPrompt is used as pure persona\n- Remove rules() injection from system message\n- Test that agents respond appropriately to new format","acceptance_criteria":"- ArenaService uses prompt builder\n- No inline prompt construction\n- Agents see XML-attributed messages\n- Debate flow works end-to-end\n- Gate passes","notes":"Integrated promptBuilder.buildPrompt into ArenaService.processTurn (replaced inline Prompt.RawInput construction + removed rules()). Added agent name lookup for agent messages and default labels for non-agent messages. Ensured system prompt is pure agent.systemPrompt. npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:31:52.009626861+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T18:25:53.837602578+01:00","closed_at":"2026-02-04T18:25:53.837602578+01:00","close_reason":"Implemented: Prompt builder integration, pure system prompt, XML attribution","dependencies":[{"issue_id":"agon-t32.6","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:31:52.010068535+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-t32.6","depends_on_id":"agon-t32.2","type":"blocks","created_at":"2026-02-04T17:32:48.476565188+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-t32.6","depends_on_id":"agon-t32.3","type":"blocks","created_at":"2026-02-04T17:32:48.510266438+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.7","title":"Phase 2: Admin UI room creation with new fields","description":"Update Admin UI room composer to support new room fields.\n\nNew fields:\n- title (input, required)\n- topic (textarea, required) \n- audienceSlotDurationSeconds (number, default 30, 0 = manual only)\n- audienceTokenLimit (number, default 4096)\n- roomTokenLimit (number, default 32000)","design":"- Update RoomComposer.tsx with new form fields\n- Update API types in packages/api\n- Validation: title required, topic required, numbers \u003e= 0\n- Show helpful labels/tooltips explaining each limit","acceptance_criteria":"- Room composer has all new fields\n- Defaults shown correctly\n- Validation works\n- Room created with correct values in D1\n- Gate passes","notes":"Added title, audienceSlotDurationSeconds, audienceTokenLimit, and roomTokenLimit fields to RoomComposer. Verified with gate.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:31:52.041652933+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T18:25:53.869660376+01:00","closed_at":"2026-02-04T18:25:53.869660376+01:00","close_reason":"Implemented: Admin UI + backend support for title, audienceSlotDurationSeconds, audienceTokenLimit, roomTokenLimit","dependencies":[{"issue_id":"agon-t32.7","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:31:52.042093234+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-t32.7","depends_on_id":"agon-t32.1","type":"blocks","created_at":"2026-02-04T17:32:48.446293786+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.8","title":"Phase 3: Discord thread lock/unlock","description":"Implement thread locking to prevent audience messages during agent processing.\n\nFlow:\n1. Lock thread BEFORE composing message to agent\n2. Sync Discord -\u003e D1\n3. LLM generate\n4. Post response to Discord\n5. Post notification (Next: X)\n6. Unlock thread\n\nBot needs MANAGE_THREADS permission.","design":"- Add lockThread(threadId) and unlockThread(threadId) to Discord service\n- PATCH /channels/:threadId with { locked: true/false }\n- Integrate into processTurn at correct points\n- Handle errors gracefully (don't crash turn if lock fails)","acceptance_criteria":"- Thread locks before agent processing\n- Thread unlocks after response posted\n- Users cannot post while locked (Discord enforces)\n- Webhooks still work while locked (agents can post)\n- Lock/unlock errors logged but don't fail turn\n- Gate passes","notes":"Review notes: Discord PATCH /channels/:threadId {locked} looks correct; processTurn uses Effect.scoped + acquireRelease so unlock finalizer should run on success/error. npm run gate passes. Only concern: MANAGE_THREADS requirement is only mentioned in code comment (not in docs/AGENTS.md). Minor: acquireRelease always attempts unlock even if lock failed → extra API call/log noise when perms/config missing.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:32:12.392807876+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T20:07:11.991020302+01:00","closed_at":"2026-02-04T20:07:11.991020302+01:00","close_reason":"Implemented: Discord thread lock/unlock with acquireRelease pattern, errors swallowed","dependencies":[{"issue_id":"agon-t32.8","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:32:12.393272293+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-t32.8","depends_on_id":"agon-t32.6","type":"blocks","created_at":"2026-02-04T17:32:48.542635706+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-t32.9","title":"Phase 3: Zombie thread recovery endpoint","description":"Admin endpoint to unlock threads that got stuck in locked state.\n\nScenario: Worker crashes after locking but before unlocking -\u003e thread stuck forever.","design":"- POST /admin/rooms/:roomId/unlock\n- Fetches room's threadId\n- Calls unlockThread(threadId)\n- Logs the recovery action\n- Returns success/failure","acceptance_criteria":"- Admin can unlock stuck threads\n- Endpoint requires admin auth\n- Action logged for audit\n- Gate passes","notes":"Implemented POST /admin/rooms/:roomId/unlock admin endpoint: fetch room, call Discord.unlockThread, log success/failure, return JSON (200 on success, 502 on Discord failure). npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T17:32:12.424281594+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T20:28:33.038766703+01:00","closed_at":"2026-02-04T20:28:33.038766703+01:00","close_reason":"Implemented: POST /admin/rooms/:roomId/unlock endpoint for zombie thread recovery","dependencies":[{"issue_id":"agon-t32.9","depends_on_id":"agon-t32","type":"parent-child","created_at":"2026-02-04T17:32:12.424790526+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-t32.9","depends_on_id":"agon-t32.8","type":"blocks","created_at":"2026-02-04T17:32:48.574399087+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-tgg","title":"Admin UI: Agents screen","description":"Implement SolidJS admin UI screen to list/create/edit/delete agents.\n\nDoD:\n- Can define agent name, systemPrompt, avatarUrl, llmProvider, llmModel\n- Calls admin API\n- Gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:12:55.08066634+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.259643938+01:00","closed_at":"2026-02-04T11:50:22.259643938+01:00","close_reason":"Implemented Solid admin Agents screen wired to /admin/agents; gate passes."}
{"id":"agon-ttj","title":"DX: fix wrangler dev TLS trust (CA bundle)","description":"Local workerd fails TLS handshake (Discord/OpenRouter) with 'TLS peer's certificate is not trusted' on some systems (notably Nix). Provide a repo-level fix so `npm run dev` works without manual env edits.\n\nApproach:\n- Add scripts/wrangler-dev.mjs wrapper to auto-detect a CA bundle and set SSL_CERT_FILE if missing.\n- Change package.json dev script to use wrapper.\n\nDoD:\n- Local calls to https://discord.com from worker succeed on affected setups\n- gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T14:49:50.786442658+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T14:56:04.787678058+01:00","closed_at":"2026-02-04T14:56:04.787678058+01:00","close_reason":"Added scripts/wrangler-dev.mjs wrapper that sets SSL_CERT_FILE to a CA bundle when missing/invalid (Nix-friendly) and updated npm run dev to use it; avoids passing secrets via argv; gate passes."}
{"id":"agon-u9g","title":"Effect Codebase Cleanup: Idiomatic Patterns \u0026 Anti-Patterns","description":"Comprehensive cleanup of Effect anti-patterns identified via effect-solutions + Effect Language Service analysis. Covers 45+ diagnostics across 15 files including unnecessary Effect.fail wrappers, unknown error types, sync throws, orDie usage, and schema constraints.","status":"open","priority":2,"issue_type":"epic","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:52:36.110386837+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T12:52:36.110386837+01:00"}
{"id":"agon-u9g.1","title":"Cleanup: Remove unnecessary Effect.fail wrappers from yieldable errors (27 instances)","description":"Schema.TaggedError creates yieldable errors that can be used directly without wrapping in Effect.fail(). The Effect Language Service identified 27 instances of unnecessary Effect.fail() wrappers in src/index.ts.\n\nFiles: src/index.ts (lines 249, 263, 272, 283, 291, 718, 808, 825, 830, 837, 845, 902, 914, 930, 947, 952, 959, 967, 1141, 1210, 1238, 1254, 1298, etc.)\n\nPattern: return yield* Effect.fail(AdminXxx.make({...})) should become return AdminXxx.make({...})","acceptance_criteria":"- All 27 instances of yield* Effect.fail(Admin*.make(...)) replaced with direct error yield\n- Effect Language Service no longer reports unnecessaryFailYieldableError for these lines\n- Gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:52:54.231706197+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T13:42:20.294228811+01:00","closed_at":"2026-02-05T13:42:20.294228811+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.1","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T12:52:54.232891257+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.10","title":"Cleanup: Replace type laundering (as unknown as) with Schema validation","description":"Found 3+ instances of 'as unknown as' type assertions that bypass type safety:\n- src/index.ts:3 instances for interaction/channel_id\n- src/lib/tokenCounter.ts:1 instance\n- src/services/LlmRouter.ts:4 instances for provider-specific config types\n\nPattern: Replace with Schema.decodeUnknown or proper type guards.","acceptance_criteria":"- All 'as unknown as' assertions eliminated or documented with justification\n- External data validated with Schema before type narrowing\n- Gate passes","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:53:34.500016345+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T14:13:02.079226583+01:00","closed_at":"2026-02-05T14:13:02.079226583+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.10","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T12:53:34.501208118+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.11","title":"Cleanup: Replace Effect.succeed(void 0) with Effect.void","description":"Single instance found in src/services/Discord.ts:180 where Effect.succeed(void 0) is used instead of the more idiomatic Effect.void.","acceptance_criteria":"- Effect.succeed(void 0) replaced with Effect.void\n- Effect Language Service no longer reports effectSucceedWithVoid\n- Gate passes","status":"closed","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:53:34.531426179+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T13:44:34.276092849+01:00","closed_at":"2026-02-05T13:44:34.276092849+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.11","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T12:53:34.532879857+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.12","title":"Cleanup: Run Effect Language Service and verify clean diagnostics","description":"Final verification task: run effect-language-service diagnostics on entire codebase and ensure no warnings or errors remain. This validates all previous cleanup tasks.\n\nCurrent status: 45 diagnostics (27 messages + 18 warnings) across 15 files.","acceptance_criteria":"- bunx effect-language-service diagnostics shows 0 errors, 0 warnings, 0 messages\n- All anti-patterns eliminated\n- Gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:53:34.564250136+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T14:13:55.884597721+01:00","closed_at":"2026-02-05T14:13:55.884597721+01:00","close_reason":"Effect Language Service shows 0 errors, 0 warnings. 4 informational messages remain (preferSchemaOverJson suggestions for JSON.stringify, not critical). All anti-patterns eliminated.","dependencies":[{"issue_id":"agon-u9g.12","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T12:53:34.572925946+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-u9g.12","depends_on_id":"agon-u9g.1","type":"blocks","created_at":"2026-02-05T12:53:34.577998755+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-u9g.12","depends_on_id":"agon-u9g.2","type":"blocks","created_at":"2026-02-05T12:53:34.579433016+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-u9g.12","depends_on_id":"agon-u9g.3","type":"blocks","created_at":"2026-02-05T12:53:34.580663001+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-u9g.12","depends_on_id":"agon-u9g.4","type":"blocks","created_at":"2026-02-05T12:53:34.581785453+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-u9g.12","depends_on_id":"agon-u9g.5","type":"blocks","created_at":"2026-02-05T12:53:34.582949132+01:00","created_by":"Rafał Krzyważnia"},{"issue_id":"agon-u9g.12","depends_on_id":"agon-u9g.6","type":"blocks","created_at":"2026-02-05T12:53:34.583825409+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.13","title":"Cleanup: Fix throwing TaggedError in Effect.tryPromise (DiscordWebhook.ts)","description":"Critical bug in src/services/DiscordWebhook.ts:52 - throwing DiscordWebhookPostFailed inside Effect.tryPromise's try block bypasses Effect's error channel.\n\nCurrent code:\n```typescript\nif (!res.ok) {\n  const body = await res.text();\n  throw DiscordWebhookPostFailed.make({ status: res.status, body });\n}\n```\n\nEven though DiscordWebhookPostFailed is a TaggedError, throwing it synchronously inside try Promise means it won't be caught by the catch callback properly. Should return Promise.reject() instead.","acceptance_criteria":"- DiscordWebhookPostFailed is returned via Promise.reject() instead of thrown\n- Error properly flows through Effect.tryPromise's catch callback\n- Effect Language Service clean for this pattern\n- Gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T13:03:24.854354753+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T13:25:13.821853566+01:00","closed_at":"2026-02-05T13:25:13.821853566+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.13","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T13:03:24.855394707+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.14","title":"Cleanup: Wrap async crypto/jwt functions in Effect","description":"The crypto and jwt modules (src/lib/crypto.ts, src/lib/jwt.ts) export pure async functions that return Promise\u003cT\u003e. These are called from Effect contexts but don't participate in Effect's error handling, retries, or interruption.\n\nFunctions to wrap:\n- jwt.ts: signJwt(), verifyJwt()\n- crypto.ts: deriveKey(), encrypt(), decrypt()\n\nCurrent signature:\n```typescript\nexport const signJwt = async (payload: JwtPayload, secret: string): Promise\u003cstring\u003e\n```\n\nTarget signature:\n```typescript\nexport const signJwt = (payload: JwtPayload, secret: string): Effect.Effect\u003cstring, JwtError\u003e\n```\n\nThis aligns with Effect best practices and allows proper error handling at call sites.","acceptance_criteria":"- All 5 async functions wrapped in Effect.tryPromise\n- Functions return Effect.Effect\u003cA, E, R\u003e instead of Promise\u003cA\u003e\n- New domain error types created for failure cases\n- All call sites updated to use yield*\n- Gate passes","notes":"Checked src/lib/crypto.ts + src/lib/jwt.ts: deriveKey/encrypt/decrypt and signJwt/verifyJwt already return Effect.Effect and wrap WebCrypto calls with Effect.tryPromise + domain errors (CryptoError/DecryptionError, JwtCryptoError/JwtDecodeError). Updated remaining call sites in test/jwt.test.ts to use Effect.runPromise. npm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T13:03:24.888419865+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T13:51:56.769884255+01:00","closed_at":"2026-02-05T13:51:56.769884255+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.14","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T13:03:24.888875206+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.15","title":"Cleanup: Refactor GitHub OAuth handler to Effect (optional)","description":"The GitHub OAuth callback handler in src/index.ts (~100 lines, lines 399-503) uses raw async/await instead of Effect. This creates inconsistency in the codebase.\n\nCurrent code uses:\n- await fetch() for token exchange\n- await res.json() for parsing\n- Raw try/catch (implied by .catch(() =\u003e null))\n\nRefactoring to Effect would provide:\n- Structured error handling with TaggedError\n- Retry capability for transient failures\n- Consistent with rest of codebase\n\nNote: This is optional as the current code works, but it's not idiomatic Effect.","acceptance_criteria":"- GitHub OAuth handler refactored to use Effect.gen\n- Effect.tryPromise used for fetch operations\n- Proper TaggedError types for GitHub API failures\n- Timeout and retry policies applied\n- Gate passes","status":"open","priority":3,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T13:03:24.919557259+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T13:03:24.919557259+01:00","dependencies":[{"issue_id":"agon-u9g.15","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T13:03:24.920017059+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.2","title":"Cleanup: Replace unknown catch errors with TaggedError wrappers (14 instances)","description":"Effect.tryPromise catch callbacks that return 'unknown' lose type safety. The Effect Language Service identified 14 instances across multiple files where catch returns (e) =\u003e e or similar untyped errors.\n\nFiles affected:\n- src/index.ts: lines 201, 622, 1730, 1745, 1862, 1885, 1926, 1968\n- src/services/Settings.ts: lines 40, 53, 84, 89, 104\n- src/services/LlmRouter.ts: line 142\n- src/services/ArenaService.ts: line 1156\n- src/services/TurnEventService.ts: line 57\n\nPattern: catch: (e) =\u003e e should become catch: (e) =\u003e new DomainError({ cause: e })","acceptance_criteria":"- All 14 instances return properly typed TaggedError instances\n- Each error type is domain-specific (e.g., DecryptionError, DbQueryError)\n- Effect Language Service no longer reports unknownInEffectCatch\n- Gate passes","notes":"Follow-up: fixed queue markEnqueued best-effort DB update in src/index.ts to use RoomDbError.make({ cause }) and swallow/log via Effect.catchAll (previously used catch: () =\u003e null). Gate still passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:52:54.263185983+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T13:42:20.340098829+01:00","closed_at":"2026-02-05T13:42:20.340098829+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.2","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T12:52:54.264781749+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.3","title":"Cleanup: Replace JS try/catch with Effect.try in generators (2 instances)","description":"The Effect Language Service identified 2 instances of JavaScript try/catch blocks inside Effect.gen generators. These should use Effect's error handling mechanisms.\n\nFiles:\n- src/index.ts:705 - decodeURIComponent in try/catch\n- src/services/TurnEventService.ts:50 - JSON.stringify in try/catch\n\nPattern: Use Effect.try or Effect.sync + Effect.option instead of JS try/catch","acceptance_criteria":"- Both try/catch blocks replaced with Effect.try or equivalent\n- Effect Language Service no longer reports tryCatchInEffectGen\n- Gate passes","notes":"Replaced JS try/catch inside Effect.gen:\n- src/index.ts /admin/settings/:key: decodeURIComponent wrapped in Effect.try + catchAll -\u003e null, return 400 when null.\n- src/services/TurnEventService.ts: JSON.stringify wrapped in Effect.try + catchAll -\u003e null.\nRan npm run gate (typecheck/lint/format) OK.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:52:54.295284589+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T13:51:56.695963419+01:00","closed_at":"2026-02-05T13:51:56.695963419+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.3","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T12:52:54.297562464+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.4","title":"Cleanup: Replace global Error with TaggedError in Discord.ts (2 instances)","description":"The Effect Language Service identified 2 instances of global Error usage in src/services/Discord.ts:\n- Line 531: catch returns global Error\n- Line 552: catch creates new Error('verify failed')\n\nGlobal errors lose type safety as untagged errors merge together in the Effect failure channel.","acceptance_criteria":"- Both instances use TaggedError instead of global Error\n- New DiscordVerifyError or similar domain error created\n- Effect Language Service no longer reports globalErrorInEffectCatch or globalErrorInEffectFailure\n- Gate passes","notes":"Reviewed src/services/Discord.ts: both global Error instances replaced with Schema.TaggedError DiscordVerifyError; no remaining 'new Error' in file. npm run gate passes locally.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:52:54.328979571+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T13:44:34.237471188+01:00","closed_at":"2026-02-05T13:44:34.237471188+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.4","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T12:52:54.330225015+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.5","title":"Cleanup: Convert sync throws to Effect.fail in jwt.ts and crypto.ts (3 instances)","description":"Synchronous throws bypass Effect's error channel and cause runtime crashes. Found 3 instances:\n\n- src/lib/jwt.ts:33 - throw new Error('Invalid base64url string')\n- src/lib/crypto.ts:55 - throw new Error('Invalid encrypted payload')\n- src/services/LlmRouter.ts:64 - throw new Error('OpenRouter returned no content')\n\nThese must be converted to return Effect.fail() with proper TaggedError types.","acceptance_criteria":"- All 3 sync throws eliminated\n- Functions return Effect.Effect\u003cA, DomainError, R\u003e instead of throwing\n- New domain errors created: JwtDecodeError, DecryptionError, LlmContentError\n- Gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:52:54.3679903+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T13:28:39.654634053+01:00","closed_at":"2026-02-05T13:28:39.654634053+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.5","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T12:52:54.369648905+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.6","title":"Cleanup: Replace Effect.orDie with proper error handling (6 instances)","description":"Effect.orDie converts recoverable errors into defects (crashes). Found 6+ instances in src/index.ts where orDie is used on external data parsing and API operations.\n\nThese should use Effect.mapError to convert to domain errors instead of making the program crash on invalid input.","acceptance_criteria":"- All 6 instances of .orDie removed from index.ts\n- Each replaced with Effect.mapError to proper domain error\n- Invalid external input (JSON, params) returns typed errors instead of defects\n- Gate passes","status":"closed","priority":1,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:52:54.401516634+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T13:28:39.694687487+01:00","closed_at":"2026-02-05T13:28:39.694687487+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.6","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T12:52:54.402708416+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.7","title":"Cleanup: Add constraints to unconstrained Schema.Number types","description":"Multiple files use Schema.Number without constraints, accepting NaN, Infinity, and negative values. Files: src/index.ts (8+), src/services/Discord.ts (2), src/services/ArenaService.ts (1), src/services/DiscordWebhook.ts (1).\n\nPattern: Schema.Number should become Schema.Number.pipe(Schema.nonNegative(), Schema.finite(), Schema.nonNaN()) for status codes, durations, etc. Use Schema.Int for integer counts.","acceptance_criteria":"- All Schema.Number for numeric IDs/status codes have constraints\n- Config values use constrained types\n- No unconstrained numeric schemas remain\n- Gate passes","notes":"Implemented numeric schema constraints:\n- Replaced unconstrained Schema.Number with Schema.Int.pipe(Schema.nonNegative(), Schema.finite(), Schema.nonNaN()) for IDs/status codes/retryAfter.\n- Added NonNegativeIntSchema in src/index.ts and used for admin payload numeric fields (maxTokens, thinkingBudgetTokens, durations, token limits).\n- Updated ArenaService RoomNotFound.roomId and Discord/DiscordWebhook error schemas.\n- Ran npm run gate: PASS.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:53:34.404126566+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T13:51:56.732674621+01:00","closed_at":"2026-02-05T13:51:56.732674621+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.7","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T12:53:34.405342424+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.8","title":"Cleanup: Replace Schema.String with Schema.NonEmptyString for IDs","description":"Empty strings are currently valid IDs with Schema.String. Found in 5+ files: src/index.ts (22 instances), src/services/DiscordWebhook.ts, src/services/LlmRouter.ts, src/services/Discord.ts, src/services/ArenaService.ts.\n\nPattern: id: Schema.String should become id: Schema.NonEmptyString or Schema.NonEmptyString.pipe(Schema.pattern(/.../)) for additional validation.","acceptance_criteria":"- All ID fields use Schema.NonEmptyString\n- Agent IDs, room IDs, channel IDs reject empty strings\n- Gate passes","notes":"Replaced ID schemas using Schema.String with Schema.NonEmptyString:\n- src/index.ts: AdminNotFound.id -\u003e NonEmptyString; AgentCreateSchema.id -\u003e optional(NonEmptyString); CreateRoomSchema parentChannelId/threadId -\u003e DiscordSnowflakeSchema (NonEmptyString + /^[0-9]{17,20}$/); agentIds -\u003e Array(NonEmptyString)\n- src/services/ArenaService.ts: AgentNotFound.agentId -\u003e NonEmptyString\n\nRan npm run gate (typecheck/lint/format) and it passed.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:53:34.435850764+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T14:13:02.007974225+01:00","closed_at":"2026-02-05T14:13:02.007974225+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.8","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T12:53:34.437050181+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-u9g.9","title":"Cleanup: Add Schema validation to raw JSON.parse calls","description":"Raw JSON.parse is used without validation at I/O boundaries. Found in:\n- src/lib/jwt.ts: JSON.parse for header/payload (2 instances)\n- src/services/Discord.ts: JSON.parse for API responses (3+ instances)\n\nPattern: Use Schema.decodeUnknown after JSON.parse to validate structure.","acceptance_criteria":"- All JSON.parse results validated with Schema\n- JwtHeaderSchema, JwtPayloadSchema, DiscordResponseSchema created\n- Invalid JSON structure returns typed parse errors\n- Gate passes","notes":"Added Schema validation after JSON.parse at I/O boundaries.\n\n- src/lib/jwt.ts: added JwtHeaderSchema/JwtPayloadSchema and validate decoded header/payload via Schema.decodeUnknown; Schema parse errors mapped to JwtDecodeError.\n- src/services/Discord.ts: added DiscordResponseSchema and validate requestJson responses via Schema.decodeUnknown (mapped to DiscordApiError). Also validate rate-limit body retry_after via Schema.decodeUnknown (effectful helper), and validate /users/@me/guilds array shape via Schema.decodeUnknown.\n\nnpm run gate passes.","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-05T12:53:34.469118891+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-05T14:13:02.044401079+01:00","closed_at":"2026-02-05T14:13:02.044401079+01:00","close_reason":"Implemented, reviewed, merged","dependencies":[{"issue_id":"agon-u9g.9","depends_on_id":"agon-u9g","type":"parent-child","created_at":"2026-02-05T12:53:34.47031408+01:00","created_by":"Rafał Krzyważnia"}]}
{"id":"agon-ysi","title":"Admin UI: Rooms monitor + room detail","description":"Admin UI screen to monitor rooms and inspect a room.\n\nDoD:\n- Rooms list with key state\n- Room detail shows participants + last N messages + current turn pointer\n- Links to Discord thread\n- Gate passes","status":"closed","priority":2,"issue_type":"task","owner":"r.krzywaznia@gmail.com","created_at":"2026-02-04T11:12:55.159103067+01:00","created_by":"Rafał Krzyważnia","updated_at":"2026-02-04T11:50:22.293365372+01:00","closed_at":"2026-02-04T11:50:22.293365372+01:00","close_reason":"Implemented Solid rooms monitor + room detail (participants + recent messages); gate passes."}
