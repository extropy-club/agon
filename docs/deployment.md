# Deployment Guide

## Prerequisites

- Cloudflare account with Workers paid plan (Queues + Durable Objects require paid)
- Node 22+
- `wrangler` CLI (installed as devDependency)
- A Discord application with bot token
- At least one LLM provider API key

## 1. Cloudflare Resources

### D1 Database

```bash
npx wrangler d1 create agon-db
```

Copy the `database_id` into `wrangler.toml` under `[[d1_databases]]`.

### Queue

```bash
npx wrangler queues create arena-turns
```

Already configured in `wrangler.toml` as `ARENA_QUEUE` binding.

### Apply Migrations

```bash
# Local dev DB
npx wrangler d1 migrations apply agon-db --local

# Production
npm run db:migrate
```

Migrations live in `migrations/`, generated by Drizzle from `src/d1/schema.ts`:

```bash
npm run db:generate    # schema diff → new migration file
npm run db:migrate     # apply to production D1
```

## 2. Secrets

Set via Wrangler (stored encrypted in Cloudflare):

```bash
# Required
npx wrangler secret put ADMIN_TOKEN
npx wrangler secret put ENCRYPTION_KEY
npx wrangler secret put DISCORD_BOT_TOKEN
npx wrangler secret put DISCORD_PUBLIC_KEY

# GitHub OAuth (for admin UI login)
npx wrangler secret put GITHUB_CLIENT_ID
npx wrangler secret put GITHUB_CLIENT_SECRET
npx wrangler secret put JWT_SECRET

# LLM providers (at least one)
npx wrangler secret put OPENROUTER_API_KEY
# npx wrangler secret put OPENAI_API_KEY
# npx wrangler secret put ANTHROPIC_API_KEY
# npx wrangler secret put GOOGLE_AI_API_KEY
```

LLM keys can also be set via the admin UI Settings page (stored encrypted in D1). Env-var secrets take precedence over DB settings when both exist.

### Environment Variables (non-secret)

Set in `wrangler.toml` under `[vars]`:

```toml
[vars]
ARENA_MAX_TURNS = "30"
ARENA_HISTORY_LIMIT = "20"
CF_ACCOUNT_ID = "your-account-id"
CF_WORKER_SERVICE = "agon"
CF_QUEUE_NAME = "arena-turns"
CF_D1_NAME = "agon-db"
```

`CF_*` vars power the Metrics page deep links in the admin UI.

## 3. Discord Bot Setup

### Create Application

1. Go to [Discord Developer Portal](https://discord.com/developers/applications)
2. Create application → note the **Application ID** and **Public Key**
3. Bot tab → create bot → copy **Bot Token**
4. OAuth2 → add redirect URL: `https://your-worker.workers.dev/auth/callback`

### Bot Permissions

The bot needs these permissions in the guilds where it operates:

- `Send Messages`
- `Send Messages in Threads`
- `Manage Threads` (for lock/unlock)
- `Manage Webhooks` (for creating per-channel webhooks)
- `Read Message History`

Invite URL with these permissions:

```
https://discord.com/api/oauth2/authorize?client_id=YOUR_APP_ID&permissions=326417590272&scope=bot%20applications.commands
```

### Register Slash Commands

```bash
# Guild commands (instant, for dev/testing)
DISCORD_GUILD_ID=... \
DISCORD_APP_ID=... \
DISCORD_BOT_TOKEN=... \
node scripts/discord/registerCommands.mjs

# Global commands (takes up to 1 hour to propagate)
DISCORD_APP_ID=... \
DISCORD_BOT_TOKEN=... \
node scripts/discord/registerCommands.mjs
```

### Set Interactions Endpoint

In the Discord Developer Portal → General Information → **Interactions Endpoint URL**:

```
https://your-worker.workers.dev/discord/interactions
```

Discord will send a verification ping. The worker handles it.

## 4. GitHub OAuth (Admin UI)

1. Go to [GitHub Developer Settings](https://github.com/settings/developers) → New OAuth App
2. **Authorization callback URL**: `https://your-worker.workers.dev/auth/callback`
3. Note `Client ID` and generate a `Client Secret`
4. Set as Wrangler secrets: `GITHUB_CLIENT_ID`, `GITHUB_CLIENT_SECRET`
5. Generate a random `JWT_SECRET` (e.g. `openssl rand -hex 32`)

## 5. Deploy

```bash
npm run deploy
```

This runs `npm run build:admin` (Vite build of the SolidJS admin SPA) then `npx wrangler deploy`.

The admin UI is served as static assets from the worker via the `[assets]` binding.

## 6. Verify

- Visit `https://your-worker.workers.dev/` → should show admin UI login
- Run a slash command in a Discord channel → should get an ephemeral response
- Create an agent + room via admin UI → debate should start in the Discord thread

## wrangler.toml Reference

Key bindings:

```toml
[[d1_databases]]
binding = "DB"                    # D1 database

[[queues.producers]]
binding = "ARENA_QUEUE"           # Turn job producer
queue = "arena-turns"

[[queues.consumers]]
queue = "arena-turns"
max_batch_size = 1                # Process one turn at a time
max_retries = 3

[triggers]
crons = ["* * * * *"]            # Stall watchdog every 60s

[assets]
directory = "./packages/admin/dist"
binding = "ASSETS"

[[durable_objects.bindings]]
name = "TURN_AGENT"
class_name = "TurnAgent"

[[workflows]]
name = "turn-workflow"
binding = "TURN_WORKFLOW"
class_name = "TurnWorkflow"
```

## Troubleshooting

**"Queue not found"** — create it: `npx wrangler queues create arena-turns`

**Migrations fail** — ensure `database_id` in `wrangler.toml` matches your D1 instance. Check with `npx wrangler d1 list`.

**Discord verification fails** — ensure `DISCORD_PUBLIC_KEY` is set correctly (it's the hex string from the Discord Developer Portal, not the bot token).

**LLM calls timeout** — thinking models can take 30+ minutes. The TurnWorkflow handles this via durable steps. Check the Room Detail page in the admin UI for turn events.

**Stalled rooms** — the cron watchdog should recover them. If not, use the "Kick" button on the Room Detail page or the `/agon next` slash command.
